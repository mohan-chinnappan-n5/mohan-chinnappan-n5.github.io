<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>All about Web Performance</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="web-perf.html"><strong aria-hidden="true">1.</strong> 1. What is Web Performance</a></li><li class="chapter-item expanded "><a href="cert.html"><strong aria-hidden="true">2.</strong> 2. What is inside a Server's Cert</a></li><li class="chapter-item expanded "><a href="async-defer.html"><strong aria-hidden="true">3.</strong> 3. async and defer</a></li><li class="chapter-item expanded "><a href="performance-api.html"><strong aria-hidden="true">4.</strong> 4. Performance API</a></li><li class="chapter-item expanded "><a href="networking/traceroute.html"><strong aria-hidden="true">5.</strong> 5. Traceroute</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="networking/mctr.html"><strong aria-hidden="true">5.1.</strong> mctr</a></li><li class="chapter-item expanded "><a href="networking/bsd-traceroute.html"><strong aria-hidden="true">5.2.</strong> bsd traceroute</a></li><li class="chapter-item expanded "><a href="networking/icmp.html"><strong aria-hidden="true">5.3.</strong> ICMP</a></li><li class="chapter-item expanded "><a href="networking/curl.html"><strong aria-hidden="true">5.4.</strong> Curl</a></li></ol></li><li class="chapter-item expanded "><a href="uiux/ui.html"><strong aria-hidden="true">6.</strong> 6. UI/UX</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="uiux/best-practices.html"><strong aria-hidden="true">6.1.</strong> Best Practices</a></li><li class="chapter-item expanded "><a href="uiux/accessibility.html"><strong aria-hidden="true">6.2.</strong> Accessibility</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">All about Web Performance</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="1-what-is-web-performance"><a class="header" href="#1-what-is-web-performance">1. What is Web Performance?</a></h1>
<h2 id="objective-measurements"><a class="header" href="#objective-measurements">Objective measurements</a></h2>
<ul>
<li>time to load</li>
<li>frames per second</li>
<li>time to become interactive</li>
</ul>
<h2 id="subjective-measurements"><a class="header" href="#subjective-measurements">Subjective measurements</a></h2>
<ul>
<li>how long it felt like it took the content to load</li>
</ul>
<h2 id="goals"><a class="header" href="#goals">Goals</a></h2>
<ul>
<li>
<p>making the experience as available and interactive as possible, as soon as possible, while asynchronously loading in the longer tail parts of the experience.</p>
</li>
<li>
<p>users want web experiences with content that is fast to load and smooth to interact with.</p>
</li>
</ul>
<h2 id="issues"><a class="header" href="#issues">Issues</a></h2>
<p>Two major issues in web performance are issues having to do with <strong>latency</strong> and issues having to do with the fact that for the most part, <strong>browsers are single-threaded</strong></p>
<ul>
<li>
<p>Browsers execute a task from beginning to end before taking up another task.</p>
<ul>
<li>Minimize the main thread's responsibilities, where possible and appropriate, to ensure rendering is smooth and responses to interactions are immediate.</li>
<li>Render time is key, ensuring the main thread can complete all the work we throw at it and still always be available to handle user interactions. </li>
</ul>
</li>
<li>
<p>The user gets the requested information as quickly as possible</p>
</li>
</ul>
<h2 id="lazy-loading"><a class="header" href="#lazy-loading">Lazy Loading</a></h2>
<ul>
<li>Lazy loading is a strategy to <strong>identify resources as non-blocking (non-critical)</strong> and load these only when needed. 
<ul>
<li>It's a way to shorten the length of the critical rendering path, which translates into reduced page load times</li>
</ul>
</li>
</ul>
<h2 id="navigation-timing"><a class="header" href="#navigation-timing">Navigation timing</a></h2>
<ul>
<li>measures <strong>the main document's</strong> timings</li>
</ul>
<h2 id="resource-timing"><a class="header" href="#resource-timing">Resource timing</a></h2>
<ul>
<li>provides the times for all the assets or resources called in by the <strong>main document</strong> and the resources' requested resources.</li>
</ul>
<h2 id="two-approaches-for-monitoring-and-providing-insight-into-web-performance"><a class="header" href="#two-approaches-for-monitoring-and-providing-insight-into-web-performance">Two approaches for monitoring and providing insight into web performance</a></h2>
<ul>
<li>Synthetic monitoring 
<ul>
<li>very well suited to regression testing and mitigating shorter-term performance issues during development</li>
</ul>
</li>
<li>Real user monitoring (RUM)
<ul>
<li>best suited for understanding long-term trends</li>
</ul>
</li>
</ul>
<h2 id="speculative-loading"><a class="header" href="#speculative-loading">Speculative loading</a></h2>
<ul>
<li>
<p>practice of performing navigation actions (such as DNS fetching, fetching resources, or rendering documents)  before the associated pages are actually visited, based on predictions as to what pages the user is most likely to visit next.</p>
</li>
<li>
<p><strong>DNS-prefetch</strong> is an attempt to resolve domain names before resources get requested. This could be a file loaded later or link target a user tries to follow.</p>
</li>
</ul>
<h2 id="latency"><a class="header" href="#latency">Latency</a></h2>
<ul>
<li>time it takes for a packet of data to travel from source to a destination.</li>
</ul>
<h2 id="dns-lookup"><a class="header" href="#dns-lookup">DNS Lookup</a></h2>
<p>Your browser requests a DNS lookup, which is eventually fielded by a <strong>name server</strong>, which in turn responds with an IP address</p>
<p>After this initial request, the IP will likely be cached for a time, which speeds up subsequent requests by retrieving the IP address from the cache instead of contacting a name server again.</p>
<p>If your fonts, images, scripts, ads, and metrics all have different hostnames, a DNS lookup will have to be made for each one.</p>
<p>This can be problematic for performance, particularly on mobile networks. When a user is on a mobile network, each DNS lookup has to go from the phone to the cell tower to reach an authoritative DNS server. The distance between a phone, a cell tower, and the name server can add significant latency.</p>
<h2 id="tcp-handshake"><a class="header" href="#tcp-handshake">TCP handshake</a></h2>
<p>Once the IP address is known, the browser sets up a connection to the server via a TCP three-way handshake.</p>
<p>This handshake step happens after a DNS lookup and before the TLS handshake, when creating a secure connection. </p>
<p>DNS Lookup --- TCP handshake --- TLS handshake</p>
<p>This mechanism is designed so that two entities attempting to communicate — in this case the browser and web server — can <strong>negotiate the parameters of the network TCP socket connection</strong> before transmitting data, often over HTTPS.</p>
<p>There are three messages ( SYN-SYN-ACK ) transmitted by TCP to negotiate and start a TCP session between two computer
Three messages back and forth between each server, and the request has yet to be made</p>
<div class="table-wrapper"><table><thead><tr><th>No.</th><th>What it does</th></tr></thead><tbody>
<tr><td>1</td><td>The initiator, generally the browser, sends a TCP SYNchronize packet to the other host, generally the server.</td></tr>
<tr><td>2</td><td>The server receives the SYN and sends back a SYNchronize-ACKnowledgement.</td></tr>
<tr><td>3</td><td>The initiator receives the server's SYN-ACK and sends an ACKnowledge. The server receives ACK and the TCP socket connection is established.</td></tr>
</tbody></table>
</div>
<p><img src="img/tcp-3way-hankdshake.png" alt="TCP 3 way handshake" /></p>
<h2 id="connection-termination---four-way-handshake"><a class="header" href="#connection-termination---four-way-handshake">Connection termination - four-way handshake</a></h2>
<div class="table-wrapper"><table><thead><tr><th>No.</th><th>What it does</th></tr></thead><tbody>
<tr><td>1</td><td>The initiator, generally the browser, sends the  FIN packet to the other host</td></tr>
<tr><td>2</td><td>The other host sends an ACK packet back to the initiator.</td></tr>
<tr><td>3</td><td>Now, the connection is half-closed, and the other host can still send data. (For example, the server can finish off sending data to the client when the client has closed its connection to the server.)</td></tr>
<tr><td>4</td><td>The other host sends a FIN packet to the initiator.</td></tr>
<tr><td>5</td><td>The initiator sends an ACK packet back to the other host.</td></tr>
</tbody></table>
</div>
<h2 id="tls-handshake"><a class="header" href="#tls-handshake">TLS handshake</a></h2>
<p>For secure connections established over HTTPS, another &quot;handshake&quot; is required.</p>
<p>This determines
- which <strong>cipher will be used to encrypt the communication</strong>
- verifies the server
- establishes that a secure connection is in place before beginning the actual transfer of data</p>
<p><img src="img/ssl.jpg" alt="SSL" /></p>
<p>Server provides the Cert  which contains the <strong>public key of the server</strong>. This key is used by clients to encrypt data that can only be decrypted by the corresponding private key held by the server.</p>
<p>While making the connection secure <strong>adds time to the page load</strong>, a secure connection is worth the latency expense, as the data transmitted between the browser and the web server cannot be decrypted by a third party.</p>
<h2 id="response"><a class="header" href="#response">Response</a></h2>
<p>Once we have an established connection to a web server, the browser sends an initial <strong>HTTP GET</strong> request on behalf of the user, which for websites is most often an HTML file. </p>
<p>Once the server receives the request, it will reply with relevant response headers and the contents of the HTML.</p>
<p>This response for this initial request contains the first byte of data received.</p>
<p>Time to First Byte (TTFB) is the time between when the user made the request — say by clicking on a link — and the receipt of this first packet of HTML. The first chunk of content is usually 14KB of data.</p>
<h2 id="tcp"><a class="header" href="#tcp">TCP</a></h2>
<p>TCP packets are split into segments during transmission.
Because TCP guarantees the sequence of packets, the server must receive an acknowledgment from the client in the form of an ACK packet after sending a certain number of segments.</p>
<p>If the server waits for an ACK after each segment, that will result in frequent ACKs from the client and may increase transmission time, even in the case of a low-load network.</p>
<p>On the other hand, sending too many segments at once can lead to the problem that in a busy network the client will not be able to receive the segments and will just keep responding with ACKs for a long time, and the server will have to keep re-sending the segments.</p>
<p>In order to balance the number of transmitted segments, the TCP slow start algorithm is used to gradually increase the amount of transmitted data until the maximum network bandwidth can be determined, and to reduce the amount of transmitted data in case of high network load.</p>
<p>The number of segments to be transmitted is controlled by the value of the congestion window (CWND), which can be initialized to 1, 2, 4, or 10 MSS (MSS is 1500 bytes over the Ethernet protocol). That value is the number of bytes to send, upon receipt of which the client must send an ACK.</p>
<p>If an ACK is received, then the CWND value will be doubled, and so the server will be able to send more segments the next time. If instead no ACK is received, then the CWND value will be halved. That mechanism thus achieves a balance between sending too many segments, and sending too few.</p>
<h2 id="parsing"><a class="header" href="#parsing">Parsing</a></h2>
<p>Once the browser receives the first chunk of data, it can begin parsing the information received. Parsing is the step the browser takes to turn the data it receives over the network into the DOM and CSSOM, which is used by the renderer to paint a page to the screen.</p>
<p>The DOM is the internal representation of the markup for the browser. The DOM is also exposed and can be manipulated through various APIs in JavaScript.</p>
<p>Even if the requested page's HTML is larger than the initial 14KB packet, the browser will begin parsing and attempting to render an experience based on the data it has. This is why it's important for web performance optimization to include everything the browser needs to start rendering a page, or at least a template of the page — the CSS and HTML needed for the first render — in the first 14KB. But before anything is rendered to the screen, the HTML, CSS, and JavaScript have to be parsed.</p>
<h2 id="dom-tree"><a class="header" href="#dom-tree">DOM Tree</a></h2>
<p>The first step is processing the HTML markup and building the DOM tree. HTML parsing involves tokenization and tree construction. HTML tokens include start and end tags, as well as attribute names and values. If the document is well-formed, parsing it is straightforward and faster. The parser parses tokenized input into the document, building up the document tree.</p>
<p>The DOM tree describes the content of the document. The html element is the first element and root node of the document tree. The tree reflects the relationships and hierarchies between different elements. Elements nested within other elements are child nodes. The greater the number of DOM nodes, the longer it takes to construct the DOM tree.</p>
<p>When the parser finds non-blocking resources, such as an image, the browser will request those resources and continue parsing.</p>
<p>Parsing can continue when a CSS file is encountered, but script elements — particularly those without an async or defer attribute — block rendering, and pause the parsing of HTML. Though the browser's preload scanner hastens this process, excessive scripts can still be a significant bottleneck.</p>
<h2 id="preload-scanner"><a class="header" href="#preload-scanner">Preload scanner</a></h2>
<p>While the browser builds the DOM tree, this process occupies the main thread. </p>
<p>While the browser builds the DOM tree, this process occupies the main thread. As this happens, the preload scanner will parse through the content available and request high-priority resources like CSS, JavaScript, and web fonts. Thanks to the preload scanner, we don't have to wait until the parser finds a reference to an external resource to request it. It will retrieve resources in the background so that by the time the main HTML parser reaches the requested assets, they may already be in flight or have been downloaded. The optimizations the preload scanner provides reduce blockages.</p>
<pre><code class="language-html">&lt;link rel=&quot;stylesheet&quot; href=&quot;styles.css&quot; /&gt;
&lt;script src=&quot;myscript.js&quot; async&gt;&lt;/script&gt;
&lt;img src=&quot;myimage.jpg&quot; alt=&quot;image description&quot; /&gt;
&lt;script src=&quot;anotherscript.js&quot; async&gt;&lt;/script&gt;

</code></pre>
<p>In this example, while the main thread is parsing the HTML and CSS, the preload scanner will find the scripts and image, and start downloading them as well. To ensure the script doesn't block the process, add the async attribute, or the defer attribute if JavaScript parsing and execution order is important.</p>
<p>Waiting to obtain CSS doesn't block HTML parsing or downloading, but it does block JavaScript because JavaScript is often used to query CSS properties' impact on elements.</p>
<h2 id="cssom-tree"><a class="header" href="#cssom-tree">CSSOM tree</a></h2>
<p>The second step in the critical rendering path is processing CSS and building the CSSOM tree. The CSS object model is similar to the DOM. The DOM and CSSOM are both trees. They are independent data structures. The browser converts the CSS rules into a map of styles it can understand and work with. The browser goes through each rule set in the CSS, creating a tree of nodes with parent, child, and sibling relationships based on the CSS selectors.</p>
<p>As with HTML, the browser needs to convert the received CSS rules into something it can work with. Hence, it repeats the HTML-to-object process, but for the CSS.</p>
<p>The CSSOM tree includes styles from the user agent style sheet. The browser begins with the most general rule applicable to a node and recursively refines the computed styles by applying more specific rules. In other words, it cascades the property values.</p>
<p>Building the CSSOM is very, very fast and is not displayed in a unique color in current developer tools. Rather, the &quot;Recalculate Style&quot; in developer tools shows the total time it takes to parse CSS, construct the CSSOM tree, and recursively calculate computed styles. In terms of web performance optimization, there are lower hanging fruit, as the total time to create the CSSOM is generally less than the time it takes for one DNS lookup.</p>
<h2 id="javascript-compilation"><a class="header" href="#javascript-compilation">JavaScript compilation</a></h2>
<p>While the CSS is being parsed and the CSSOM created, other assets, including JavaScript files, are downloading (thanks to the preload scanner). JavaScript is parsed, compiled, and interpreted. The scripts are parsed into abstract syntax trees. Some browser engines take the abstract syntax trees and pass them into a compiler, outputting bytecode. This is known as JavaScript compilation. Most of the code is interpreted on the main thread, but there are exceptions such as code run in web workers.</p>
<h2 id="accessibility-tree-aom"><a class="header" href="#accessibility-tree-aom">Accessibility tree (AOM)</a></h2>
<p>The browser also builds an accessibility tree that assistive devices use to parse and interpret content. The accessibility object model (AOM) is like a semantic version of the DOM. The browser updates the accessibility tree when the DOM is updated. The accessibility tree is not modifiable by assistive technologies themselves</p>
<p>Until the AOM is built, the content is not accessible to screen readers.</p>
<h2 id="render"><a class="header" href="#render">Render</a></h2>
<p>Rendering steps include style, layout, paint, and in some cases compositing. The CSSOM and DOM trees created in the parsing step are combined into a render tree which is then used to compute the layout of every visible element, which is then painted to the screen. In some cases, content can be promoted to its own layer and composited, improving performance by painting portions of the screen on the GPU instead of the CPU, freeing up the main thread.</p>
<h2 id="style"><a class="header" href="#style">Style</a></h2>
<p>The third step in the critical rendering path is combining the DOM and CSSOM into a render tree. The computed style tree, or render tree, construction starts with the root of the DOM tree, traversing each visible node.</p>
<p>Elements that aren't going to be displayed, like the head element and its children and any nodes with display: none, such as the script <code>{ display: none; }</code> you will find in user agent stylesheets, are not included in the render tree as they will not appear in the rendered output. Nodes with <code>visibility: hidden</code> applied are included in the render tree, as they do take up space. As we have not given any directives to override the user agent default, the script node in our code example above will not be included in the render tree.</p>
<p>Each visible node has its CSSOM rules applied to it. The render tree holds all the visible nodes with content and computed styles — matching up all the relevant styles to every visible node in the DOM tree, and determining, based on the CSS cascade, what the computed styles are for each node.</p>
<h2 id="layout"><a class="header" href="#layout">Layout</a></h2>
<p>The fourth step in the critical rendering path is running layout on the render tree to compute the geometry of each node. Layout is the process by which the dimensions and location of all the nodes in the render tree are determined, plus the determination of the size and position of each object on the page. Reflow is any subsequent size and position determination of any part of the page or the entire document.</p>
<p>Once the render tree is built, layout commences. The render tree identified which nodes are displayed (even if invisible) along with their computed styles, but not the dimensions or location of each node. To determine the exact size and position of each object, the browser starts at the root of the render tree and traverses it.</p>
<p>On the web page, almost everything is a box. Different devices and different desktop preferences mean an unlimited number of differing viewport sizes. In this phase, taking the viewport size into consideration, the browser determines what the sizes of all the different boxes are going to be on the screen. Taking the size of the viewport as its base, layout generally starts with the body, laying out the sizes of all the body's descendants, with each element's box model properties, providing placeholder space for replaced elements it doesn't know the dimensions of, such as our image.</p>
<p>The first time the size and position of each node is determined is called layout. Subsequent recalculations of are called reflows. In our example, suppose the initial layout occurs before the image is returned. Since we didn't declare the dimensions of our image, there will be a reflow once the image dimensions are known.</p>
<h2 id="paint"><a class="header" href="#paint">Paint</a></h2>
<p>The last step in the critical rendering path is painting the individual nodes to the screen, the first occurrence of which is called the first meaningful paint. In the painting or rasterization phase, the browser converts each box calculated in the layout phase to actual pixels on the screen. Painting involves drawing every visual part of an element to the screen, including text, colors, borders, shadows, and replaced elements like buttons and images. The browser needs to do this super quickly.</p>
<p>To ensure smooth scrolling and animation, everything occupying the main thread, including calculating styles, along with reflow and paint, must take the browser less than 16.67ms to accomplish. At 2048 x 1536, the iPad has over 3,145,000 pixels to be painted to the screen. That is a lot of pixels that have to be painted very quickly. To ensure repainting can be done even faster than the initial paint, the drawing to the screen is generally broken down into several layers. If this occurs, then compositing is necessary.</p>
<p>Painting can break the elements in the layout tree into layers. Promoting content into layers on the GPU (instead of the main thread on the CPU) improves paint and repaint performance. There are specific properties and elements that instantiate a layer, including video and canvas, and any element which has the CSS properties of opacity, a 3D transform, will-change, and a few others. These nodes will be painted onto their own layer, along with their descendants, unless a descendant necessitates its own layer for one (or more) of the above reasons.</p>
<p>Layers do improve performance but are expensive when it comes to memory management, so should not be overused as part of web performance optimization strategies.</p>
<h2 id="compositing"><a class="header" href="#compositing">Compositing</a></h2>
<p>When sections of the document are drawn in different layers, overlapping each other, compositing is necessary to ensure they are drawn to the screen in the right order and the content is rendered correctly.</p>
<p>As the page continues to load assets, reflows can happen (recall our example image that arrived late). A reflow sparks a repaint and a re-composite. Had we defined the dimensions of our image, no reflow would have been necessary, and only the layer that needed to be repainted would be repainted, and composited if necessary. But we didn't include the image dimensions! When the image is obtained from the server, the rendering process goes back to the layout steps and restarts from there.</p>
<h2 id="interactivity"><a class="header" href="#interactivity">Interactivity</a></h2>
<p>Once the main thread is done painting the page, you would think we would be &quot;all set.&quot; That isn't necessarily the case. If the load includes JavaScript, that was correctly deferred, and only executed after the onload event fires, the main thread might be busy, and not available for scrolling, touch, and other interactions.</p>
<p>Time to Interactive (TTI) is the measurement of how long it took from that first request which led to the DNS lookup and TCP connection to when the page is interactive — interactive being the point in time after the First Contentful Paint when the page responds to user interactions within <strong>50ms</strong>. If the main thread is occupied parsing, compiling, and executing JavaScript, it is not available and therefore not able to respond to user interactions in a timely (less than 50ms) fashion.</p>
<p>In our example, maybe the image loaded quickly, but perhaps the anotherscript.js file was 2MB and our user's network connection was slow. In this case, the user would see the page super quickly, but wouldn't be able to scroll without jank until the script was downloaded, parsed, and executed. That is not a good user experience. Avoid occupying the main thread, as demonstrated in this WebPageTest example:</p>
<p><img src="img/waterfall.png" alt="Waterfall" /></p>
<p>In this example, JavaScript execution took over 1.5 seconds, and the main thread was fully occupied that entire time, unresponsive to click events or screen taps.</p>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/Performance">MDN - Web performance</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="2-what-is-inside-a-servers-cert"><a class="header" href="#2-what-is-inside-a-servers-cert">2. What is inside a Server's Cert</a></h1>
<p>A server certificate, commonly referred to as an SSL/TLS certificate, contains several important pieces of information that are used to establish secure communication between a client (like a web browser) and a server. Here's what is typically found inside a server certificate:</p>
<h3 id="1-certificate-version"><a class="header" href="#1-certificate-version">1. <strong>Certificate Version</strong></a></h3>
<ul>
<li>Indicates the version of the X.509 standard that the certificate follows. The most common version is X.509 v3.</li>
</ul>
<h3 id="2-serial-number"><a class="header" href="#2-serial-number">2. <strong>Serial Number</strong></a></h3>
<ul>
<li>A unique identifier assigned by the certificate authority (CA) that issued the certificate. It helps distinguish this certificate from others issued by the same CA.</li>
</ul>
<h3 id="3-signature-algorithm"><a class="header" href="#3-signature-algorithm">3. <strong>Signature Algorithm</strong></a></h3>
<ul>
<li>Specifies the algorithm used by the CA to sign the certificate. Common algorithms include SHA-256 with RSA encryption (<code>sha256WithRSAEncryption</code>).</li>
</ul>
<h3 id="4-issuer"><a class="header" href="#4-issuer">4. <strong>Issuer</strong></a></h3>
<ul>
<li>The entity that issued the certificate, usually a trusted certificate authority (CA). This field includes the CA's distinguished name (DN), which might contain information like the CA's organization name, country, and more.</li>
</ul>
<h3 id="5-validity-period"><a class="header" href="#5-validity-period">5. <strong>Validity Period</strong></a></h3>
<ul>
<li><strong>Not Before</strong>: The date and time from which the certificate is valid.</li>
<li><strong>Not After</strong>: The expiration date and time of the certificate.</li>
</ul>
<h3 id="6-subject"><a class="header" href="#6-subject">6. <strong>Subject</strong></a></h3>
<ul>
<li>The entity to which the certificate has been issued. This field contains the subject's distinguished name (DN), which often includes the following:
<ul>
<li><strong>Common Name (CN)</strong>: Usually the domain name of the server (e.g., <code>www.example.com</code>).</li>
<li><strong>Organization (O)</strong>: The organization that owns the certificate.</li>
<li><strong>Organizational Unit (OU)</strong>: The department within the organization.</li>
<li><strong>Country (C)</strong>: The country where the organization is located.</li>
</ul>
</li>
</ul>
<h3 id="7-public-key"><a class="header" href="#7-public-key">7. <strong>Public Key</strong></a></h3>
<ul>
<li>Contains the public key of the server. This key is used by clients to encrypt data that can only be decrypted by the corresponding private key held by the server.</li>
</ul>
<h3 id="8-subject-alternative-name-san"><a class="header" href="#8-subject-alternative-name-san">8. <strong>Subject Alternative Name (SAN)</strong></a></h3>
<ul>
<li>A list of additional domain names or IP addresses that the certificate is valid for. This allows a single certificate to cover multiple domains or subdomains.</li>
</ul>
<h3 id="9-key-usage"><a class="header" href="#9-key-usage">9. <strong>Key Usage</strong></a></h3>
<ul>
<li>Specifies the purpose of the public key contained in the certificate. It defines whether the key is used for digital signatures, key encipherment, certificate signing, etc.</li>
</ul>
<h3 id="10-extended-key-usage"><a class="header" href="#10-extended-key-usage">10. <strong>Extended Key Usage</strong></a></h3>
<ul>
<li>Specifies additional purposes for which the certificate may be used, such as server authentication, client authentication, code signing, email protection, etc.</li>
</ul>
<h3 id="11-certificate-policies"><a class="header" href="#11-certificate-policies">11. <strong>Certificate Policies</strong></a></h3>
<ul>
<li>Specifies the policies under which the certificate was issued. This might include a policy identifier and additional information that describes the terms and conditions of the certificate's use.</li>
</ul>
<h3 id="12-authority-key-identifier"><a class="header" href="#12-authority-key-identifier">12. <strong>Authority Key Identifier</strong></a></h3>
<ul>
<li>A reference to the public key of the issuing CA, which helps clients verify the authenticity of the certificate.</li>
</ul>
<h3 id="13-subject-key-identifier"><a class="header" href="#13-subject-key-identifier">13. <strong>Subject Key Identifier</strong></a></h3>
<ul>
<li>A unique identifier for the public key contained in the certificate. This is used to facilitate certificate path building.</li>
</ul>
<h3 id="14-basic-constraints"><a class="header" href="#14-basic-constraints">14. <strong>Basic Constraints</strong></a></h3>
<ul>
<li>Indicates whether the certificate is for a CA and how deep a certification path is allowed to be (e.g., whether the certificate can be used to sign other certificates).</li>
</ul>
<h3 id="15-crl-distribution-points"><a class="header" href="#15-crl-distribution-points">15. <strong>CRL Distribution Points</strong></a></h3>
<ul>
<li>Contains information about where to obtain the Certificate Revocation List (CRL) if the certificate has been revoked.</li>
</ul>
<h3 id="16-authority-information-access-aia"><a class="header" href="#16-authority-information-access-aia">16. <strong>Authority Information Access (AIA)</strong></a></h3>
<ul>
<li>Provides information on how to access the CA's certificate, often used for chaining certificates back to a trusted root.</li>
</ul>
<h3 id="17-digital-signature"><a class="header" href="#17-digital-signature">17. <strong>Digital Signature</strong></a></h3>
<ul>
<li>A digital signature created by the CA using its private key. This signature is used to verify that the certificate was indeed issued by the trusted CA and that it hasn't been tampered with.</li>
</ul>
<h3 id="optional-fields-and-extensions"><a class="header" href="#optional-fields-and-extensions"><strong>Optional Fields and Extensions</strong></a></h3>
<ul>
<li><strong>Certificate Transparency (SCT)</strong>: Logs included to provide transparency and detect certificate misissuance.</li>
<li><strong>OCSP Stapling</strong>: An extension that provides a signed timestamped response from the CA, verifying the certificate status.</li>
<li><strong>Custom Extensions</strong>: Some certificates may include custom extensions for specific use cases.</li>
</ul>
<p>The information inside a server certificate is critical for establishing trust between the server and the client, ensuring secure communication, and verifying the identity of the server. This data structure is standardized under the X.509 specification, and each part plays a role in the security and validity of the certificate.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="3-async-and-defer"><a class="header" href="#3-async-and-defer">3. async and defer</a></h1>
<p>Using <code>async</code> in a <code>&lt;script&gt;</code> tag in HTML is a way to control how the browser loads and executes JavaScript files. It is particularly useful for optimizing the loading performance of a web page. Here's what <code>async</code> does and how it differs from other script loading techniques:</p>
<h3 id="purpose-of-async-in-script-tag"><a class="header" href="#purpose-of-async-in-script-tag"><strong>Purpose of <code>async</code> in <code>&lt;script&gt;</code> Tag</strong></a></h3>
<ul>
<li>The <code>async</code> attribute allows the browser to load the script file in the background while it continues to parse the HTML document. Once the script is fully loaded, it is executed immediately, without waiting for the entire HTML to be parsed.</li>
</ul>
<h3 id="how-async-works"><a class="header" href="#how-async-works"><strong>How <code>async</code> Works</strong></a></h3>
<ul>
<li>When a script is marked with <code>async</code>, the browser starts downloading the script as soon as it encounters the <code>&lt;script&gt;</code> tag.</li>
<li>The HTML parsing continues while the script is being downloaded.</li>
<li>As soon as the script is fully downloaded, the HTML parsing is paused, and the script is executed immediately.</li>
<li>Once the script execution is complete, the browser resumes parsing the HTML.</li>
</ul>
<h3 id="when-to-use-async"><a class="header" href="#when-to-use-async"><strong>When to Use <code>async</code></strong></a></h3>
<ul>
<li>
<p><strong>Independent Scripts</strong>: Use <code>async</code> for scripts that don't rely on other scripts or DOM elements that come after the script tag. For example, analytics scripts or tracking codes often use <code>async</code> because they don’t depend on the rest of the page’s content.</p>
</li>
<li>
<p><strong>Performance Optimization</strong>: <code>async</code> can be used to speed up page load times by allowing scripts to load in parallel with the HTML parsing.</p>
</li>
</ul>
<h3 id="syntax"><a class="header" href="#syntax"><strong>Syntax</strong></a></h3>
<pre><code class="language-html">&lt;script src=&quot;script.js&quot; async&gt;&lt;/script&gt;
</code></pre>
<h3 id="comparison-with-other-loading-strategies"><a class="header" href="#comparison-with-other-loading-strategies"><strong>Comparison with Other Loading Strategies</strong></a></h3>
<ul>
<li>
<p><strong>Without <code>async</code> or <code>defer</code> (Default Behavior)</strong>:</p>
<ul>
<li>The browser stops HTML parsing to download the script and then executes it before continuing to parse the HTML. This can block the page from rendering quickly.</li>
</ul>
</li>
<li>
<p><strong>With <code>defer</code></strong>:</p>
<ul>
<li>Similar to <code>async</code>, the script is downloaded in parallel with HTML parsing. However, with <code>defer</code>, the script execution is deferred until after the HTML has been fully parsed. This ensures that the script does not block the rendering of the page, making it more predictable, especially for scripts that rely on the DOM.</li>
</ul>
</li>
<li>
<p><strong>With <code>async</code></strong>:</p>
<ul>
<li>The script is also downloaded in parallel with HTML parsing but is executed as soon as it’s ready, potentially before the HTML is fully parsed. This can lead to issues if the script relies on elements that haven’t been parsed yet.</li>
</ul>
</li>
</ul>
<h3 id="use-cases"><a class="header" href="#use-cases"><strong>Use Cases</strong></a></h3>
<ul>
<li><strong><code>async</code></strong> is ideal for scripts like analytics or advertisements that don’t depend on other content and where you want to minimize the impact on page load time.</li>
<li><strong><code>defer</code></strong> is better for scripts that should run after the document has been fully parsed, like those manipulating DOM elements that appear later in the HTML.</li>
</ul>
<h3 id="example-usage"><a class="header" href="#example-usage"><strong>Example Usage</strong></a></h3>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;Async Script Example&lt;/title&gt;
    &lt;script src=&quot;analytics.js&quot; async&gt;&lt;/script&gt; &lt;!-- Independent script that runs as soon as it's ready --&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Async Script Demo&lt;/h1&gt;
    &lt;p&gt;This content loads while the script is being fetched asynchronously.&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>In this example, <code>analytics.js</code> will load in the background, allowing the rest of the page to be parsed and displayed without waiting for the script to finish downloading. Once <code>analytics.js</code> is ready, it will be executed immediately.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="4-performance-api"><a class="header" href="#4-performance-api">4. Performance API</a></h1>
<p>The Performance API is a group of standards used to measure the performance of web applications.</p>
<p>The performance timeline contains high precision timestamps and can be displayed in developer tools. You can also send its data to analytics end points to record performance metrics over time.</p>
<p>Each performance metric is represented by a single PerformanceEntry. A performance entry has a name, a duration, a startTime, and a type. All performance metrics extend the PerformanceEntry interface and qualify it further.</p>
<p>The Performance API in web browsers is a powerful tool that provides detailed timing and performance data about how web pages and applications load and run. It is a part of the larger set of Web APIs and allows developers to measure the speed of various aspects of their web applications, helping them optimize performance and improve user experience.</p>
<h3 id="key-components-of-the-performance-api"><a class="header" href="#key-components-of-the-performance-api"><strong>Key Components of the Performance API</strong></a></h3>
<ol>
<li>
<p><strong>Performance Interface</strong></p>
<ul>
<li>The <code>window.performance</code> object is the main entry point for accessing the Performance API. It provides various methods and properties to measure and retrieve performance-related information.</li>
</ul>
<pre><code class="language-javascript">const perf = window.performance;
</code></pre>
</li>
<li>
<p><strong>Performance Timeline</strong></p>
<ul>
<li>
<p>The Performance Timeline API allows developers to retrieve a detailed list of performance-related events and marks. It includes interfaces like <code>PerformanceEntry</code>, <code>PerformanceMark</code>, <code>PerformanceMeasure</code>, and <code>PerformanceObserver</code>.</p>
</li>
<li>
<p><strong>PerformanceEntry</strong>: Represents individual performance-related events, such as marks, measures, or resource timings.</p>
</li>
<li>
<p><strong>PerformanceMark</strong>: Allows developers to create custom timestamps in the performance timeline.</p>
</li>
<li>
<p><strong>PerformanceMeasure</strong>: Measures the duration between two marks or between a mark and the current time.</p>
</li>
</ul>
<pre><code class="language-javascript">performance.mark('start');
// Some code to measure
performance.mark('end');
performance.measure('duration', 'start', 'end');
const measure = performance.getEntriesByName('duration')[0];
console.log(measure.duration);
</code></pre>
</li>
<li>
<p><strong>Navigation Timing</strong></p>
<ul>
<li>The Navigation Timing API provides detailed timing information about the loading of the document, from the initial request to the completion of the load event. This includes DNS lookup time, connection time, response time, and more.</li>
</ul>
<pre><code class="language-javascript">const timing = performance.timing;
const pageLoadTime = timing.loadEventEnd - timing.navigationStart;
console.log(`Page load time: ${pageLoadTime} ms`);
</code></pre>
</li>
<li>
<p><strong>Resource Timing</strong></p>
<ul>
<li>The Resource Timing API provides timing information for each resource (e.g., scripts, images, stylesheets) loaded by the page. It allows developers to see how long each resource takes to fetch, which can be crucial for identifying slow resources.</li>
</ul>
<pre><code class="language-javascript">const resources = performance.getEntriesByType('resource');
resources.forEach(resource =&gt; {
    console.log(`Resource ${resource.name} took ${resource.duration} ms to load.`);
});
</code></pre>
</li>
<li>
<p><strong>User Timing</strong></p>
<ul>
<li>The User Timing API allows developers to create custom performance metrics by marking specific points in the code and measuring the time between them. This is particularly useful for measuring the performance of specific functions or user interactions.</li>
</ul>
<pre><code class="language-javascript">performance.mark('startWork');
// Perform some work
performance.mark('endWork');
performance.measure('workDuration', 'startWork', 'endWork');
const workDuration = performance.getEntriesByName('workDuration')[0].duration;
console.log(`Work duration: ${workDuration} ms`);
</code></pre>
</li>
<li>
<p><strong>PerformanceObserver</strong></p>
<ul>
<li>The PerformanceObserver API allows developers to observe and respond to performance events as they occur. This is useful for tracking performance in real-time.</li>
</ul>
<pre><code class="language-javascript">const observer = new PerformanceObserver((list) =&gt; {
    const entries = list.getEntries();
    entries.forEach(entry =&gt; {
        console.log(`Observed ${entry.entryType} entry:`, entry);
    });
});

observer.observe({ entryTypes: ['mark', 'measure'] });
</code></pre>
</li>
</ol>
<h3 id="use-cases-of-the-performance-api"><a class="header" href="#use-cases-of-the-performance-api"><strong>Use Cases of the Performance API</strong></a></h3>
<ol>
<li>
<p><strong>Page Load Performance</strong></p>
<ul>
<li>Measure how long it takes for the page to load completely, including all resources, scripts, and images.</li>
</ul>
</li>
<li>
<p><strong>Resource Load Timing</strong></p>
<ul>
<li>Identify slow-loading resources that might be causing delays in rendering or user interactions.</li>
</ul>
</li>
<li>
<p><strong>Custom User Timings</strong></p>
<ul>
<li>Track specific user interactions or code execution paths to understand where bottlenecks occur.</li>
</ul>
</li>
<li>
<p><strong>Real-time Performance Monitoring</strong></p>
<ul>
<li>Use <code>PerformanceObserver</code> to monitor performance events as they happen and respond immediately.</li>
</ul>
</li>
</ol>
<h3 id="limitations-of-the-performance-api"><a class="header" href="#limitations-of-the-performance-api"><strong>Limitations of the Performance API</strong></a></h3>
<ul>
<li><strong>Browser Support</strong>: While widely supported, older browsers may not support all features of the Performance API.</li>
<li><strong>Complexity</strong>: Interpreting the detailed performance data can be complex, requiring a good understanding of web performance principles.</li>
<li><strong>Security and Privacy</strong>: The Performance API may expose sensitive timing information that can be exploited, leading to potential security risks such as timing attacks.</li>
</ul>
<h3 id="conclusion"><a class="header" href="#conclusion"><strong>Conclusion</strong></a></h3>
<p>The Performance API is a robust toolset that provides developers with the means to deeply analyze and optimize the performance of their web applications. By leveraging its capabilities, developers can significantly enhance the user experience by ensuring faster load times, smoother interactions, and more responsive applications.</p>
<h2 id="waterfall"><a class="header" href="#waterfall">Waterfall</a></h2>
<p>Creating a waterfall diagram using the Performance API involves visualizing the sequence and timing of resource loading on a web page. A waterfall diagram typically shows how long each resource (e.g., HTML, CSS, JS, images) takes to load, from the start of the request to the completion of the response.</p>
<h3 id="steps-to-draw-a-waterfall-diagram-using-the-performance-api"><a class="header" href="#steps-to-draw-a-waterfall-diagram-using-the-performance-api"><strong>Steps to Draw a Waterfall Diagram Using the Performance API</strong></a></h3>
<ol>
<li>
<p><strong>Collect Performance Data</strong></p>
<ul>
<li>Use the <code>performance.getEntriesByType('resource')</code> method to gather data about the resources loaded on the page. This will give you an array of <code>PerformanceResourceTiming</code> objects, each containing detailed timing information for a resource.</li>
</ul>
<pre><code class="language-javascript">const resources = performance.getEntriesByType('resource');
</code></pre>
</li>
<li>
<p><strong>Extract Timing Information</strong></p>
<ul>
<li>For each resource, extract the relevant timing data, such as <code>startTime</code>, <code>responseEnd</code>, and <code>duration</code>.</li>
</ul>
<pre><code class="language-javascript">const timings = resources.map(resource =&gt; ({
    name: resource.name,
    startTime: resource.startTime,
    duration: resource.duration,
    requestStart: resource.requestStart,
    responseEnd: resource.responseEnd,
}));
</code></pre>
</li>
<li>
<p><strong>Sort Resources by Start Time</strong></p>
<ul>
<li>To create a waterfall diagram, resources should be displayed in the order they were requested. Sort the resources by <code>startTime</code>.</li>
</ul>
<pre><code class="language-javascript">timings.sort((a, b) =&gt; a.startTime - b.startTime);
</code></pre>
</li>
<li>
<p><strong>Visualize the Data</strong></p>
<ul>
<li>Use an HTML <code>&lt;canvas&gt;</code>, SVG, or a charting library like D3.js to draw the waterfall diagram. Each resource can be represented as a horizontal bar starting at <code>startTime</code> and extending to <code>responseEnd</code>.</li>
</ul>
<p>Here’s a basic example using HTML and a <code>&lt;canvas&gt;</code> element:</p>
<pre><code class="language-html">&lt;canvas id=&quot;waterfall&quot; width=&quot;800&quot; height=&quot;400&quot;&gt;&lt;/canvas&gt;
&lt;script&gt;
    const canvas = document.getElementById('waterfall');
    const ctx = canvas.getContext('2d');
    const rowHeight = 20;
    const startX = 100;  // Starting X position for the bars
    const scale = 2;     // Scale factor for converting time to pixels

    timings.forEach((timing, index) =&gt; {
        const y = index * rowHeight;
        const width = timing.duration * scale;
        const x = timing.startTime * scale + startX;

        // Draw the background bar for the total duration
        ctx.fillStyle = '#ccc';
        ctx.fillRect(x, y, width, rowHeight - 2);

        // Draw the name of the resource
        ctx.fillStyle = '#000';
        ctx.fillText(timing.name, 10, y + rowHeight / 2);
    });
&lt;/script&gt;
</code></pre>
</li>
<li>
<p><strong>Customize and Enhance</strong></p>
<ul>
<li><strong>Labels</strong>: Add labels for each resource to show the resource name and duration.</li>
<li><strong>Color Coding</strong>: Use different colors to represent different types of resources (e.g., HTML, CSS, JS).</li>
<li><strong>Tooltips</strong>: Add tooltips to display detailed timing information when hovering over each bar.</li>
</ul>
</li>
<li>
<p><strong>Consider Using a Library</strong></p>
<ul>
<li>For more complex and feature-rich waterfall diagrams, consider using a library like <strong>D3.js</strong> or <strong>Chart.js</strong>. These libraries can help manage scales, axes, tooltips, and interactions more effectively.</li>
</ul>
</li>
</ol>
<h3 id="example-using-d3js"><a class="header" href="#example-using-d3js"><strong>Example Using D3.js</strong></a></h3>
<p>If you want to use D3.js for more sophisticated visualization:</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Waterfall Chart&lt;/title&gt;
    &lt;script src=&quot;https://d3js.org/d3.v6.min.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;svg width=&quot;800&quot; height=&quot;400&quot;&gt;&lt;/svg&gt;
    &lt;script&gt;
        const svg = d3.select(&quot;svg&quot;);
        const margin = { top: 20, right: 30, bottom: 30, left: 150 };
        const width = +svg.attr(&quot;width&quot;) - margin.left - margin.right;
        const height = +svg.attr(&quot;height&quot;) - margin.top - margin.bottom;

        const g = svg.append(&quot;g&quot;).attr(&quot;transform&quot;, `translate(${margin.left},${margin.top})`);

        // Scale
        const x = d3.scaleLinear().range([0, width]);
        const y = d3.scaleBand().range([0, height]).padding(0.1);

        // Data
        const timings = resources.map(resource =&gt; ({
            name: resource.name,
            startTime: resource.startTime,
            duration: resource.duration
        })).sort((a, b) =&gt; a.startTime - b.startTime);

        x.domain([0, d3.max(timings, d =&gt; d.startTime + d.duration)]);
        y.domain(timings.map(d =&gt; d.name));

        // Bars
        g.selectAll(&quot;.bar&quot;)
            .data(timings)
            .enter().append(&quot;rect&quot;)
            .attr(&quot;class&quot;, &quot;bar&quot;)
            .attr(&quot;x&quot;, d =&gt; x(d.startTime))
            .attr(&quot;y&quot;, d =&gt; y(d.name))
            .attr(&quot;width&quot;, d =&gt; x(d.duration))
            .attr(&quot;height&quot;, y.bandwidth())
            .attr(&quot;fill&quot;, &quot;steelblue&quot;);

        // Axes
        g.append(&quot;g&quot;).call(d3.axisLeft(y));
        g.append(&quot;g&quot;).call(d3.axisBottom(x)).attr(&quot;transform&quot;, `translate(0,${height})`);
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="conclusion-1"><a class="header" href="#conclusion-1"><strong>Conclusion</strong></a></h3>
<p>Drawing a waterfall diagram using the Performance API can provide insightful visualizations for analyzing and optimizing resource loading on web pages. Whether you use a basic <code>&lt;canvas&gt;</code> approach or a more advanced library like D3.js, this method allows you to see how each resource contributes to the overall load time, helping you to identify and address performance bottlenecks.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="5-traceroute"><a class="header" href="#5-traceroute">5. Traceroute</a></h1>
<p>traceroute utilizes the IP protocol <strong>time to live</strong> field and attempts to elicit an ICMP TIME_EXCEEDED response from each gateway along the path to some host.</p>
<h2 id="man-page"><a class="header" href="#man-page">man page</a></h2>
<pre><code>TRACEROUTE(8)                                                                  System Manager's Manual                                                                 TRACEROUTE(8)

NAME
     traceroute – print the route packets take to network host

SYNOPSIS
     traceroute [-adeEFISdNnrvx] [-A as_server] [-f first_ttl] [-g gateway] [-i iface] [-M first_ttl] [-m max_ttl] [-P proto] [-p port] [-q nqueries] [-s src_addr] [-t tos]
                [-w waittime] [-z pausemsecs] host [packetsize]

DESCRIPTION
     The Internet is a large and complex aggregation of network hardware, connected together by gateways.  Tracking the route one's packets follow (or finding the miscreant gateway
     that's discarding your packets) can be difficult.  traceroute utilizes the IP protocol `time to live' field and attempts to elicit an ICMP TIME_EXCEEDED response from each
     gateway along the path to some host.

     The only mandatory parameter is the destination host name or IP number.  The default probe datagram length is 40 bytes, but this may be increased by specifying a packet size
     (in bytes) after the destination host name.

     Other options are:

     -a      Turn on AS# lookups for each hop encountered.

     -A as_server
             Turn  on  AS#  lookups  and  use the given server instead of the default.

     -d      Enable socket level debugging.

     -D      When an ICMP response to our probe datagram is received, print the differences between the transmitted packet and the packet quoted by the ICMP response.  A key
             showing the location of fields within the transmitted packet is printed, followed by the original packet in hex, followed by the quoted packet in hex.  Bytes that are
             unchanged in the quoted packet are shown as underscores.  Note, the IP checksum and the TTL of the quoted packet are not expected to match.  By default, only one probe
             per hop is sent with this option.

     -E      Detect ECN bleaching.  Set the IPTOS_ECN_ECT1 bit and report if that value has been bleached or mangled.

     -e      Firewall evasion mode.  Use fixed destination ports for UDP and TCP probes.  The destination port does NOT increment with each packet sent.

     -f first_ttl
             Set the initial time-to-live used in the first outgoing probe packet.

     -F      Set the &quot;don't fragment&quot; bit.

     -g gateway
             Specify a loose source route gateway (8 maximum).

    -i iface
             Specify a network interface to obtain the source IP address for outgoing probe packets. This is normally only useful on a multi-homed host. (See the -s flag for
             another way to do this.)

     -I      Use ICMP ECHO instead of UDP datagrams.  (A synonym for &quot;-P icmp&quot;).

     -M first_ttl
             Set the initial time-to-live value used in outgoing probe packets.  The default is 1, i.e., start with the first hop.

     -m max_ttl
             Set the max time-to-live (max number of hops) used in outgoing probe packets.  The default is net.inet.ip.ttl hops (the same default used for TCP connections).

     -n      Print hop addresses numerically rather than symbolically and numerically (saves a nameserver address-to-name lookup for each gateway found on the path).

     -P proto
             Send packets of specified IP protocol. The currently supported protocols are: UDP , TCP , GRE and ICMP Other protocols may also be specified (either by name or by
             number), though traceroute does not implement any special knowledge of their packet formats. This option is useful for determining which router along a path may be
             blocking packets based on IP protocol number. But see BUGS below.

     -p port
             Protocol specific. For UDP and TCP, sets the base port number used in probes (default is 33434).  traceroute hopes that nothing is listening on UDP ports base to
             base+nhops-1 at the destination host (so an ICMP PORT_UNREACHABLE message will be returned to terminate the route tracing).  If something is listening on a port in the
             default range, this option can be used to pick an unused port range.

     -q nqueries
             Set the number of probes per ``ttl'' to nqueries (default is three probes).

     -r      Bypass the normal routing tables and send directly to a host on an attached network.  If the host is not on a directly-attached network, an error is returned.  This
             option can be used to ping a local host through an interface that has no route through it (e.g., after the interface was dropped by routed(8)).

     -s src_addr
             Use the following IP address (which must be given as an IP number, not a hostname) as the source address in outgoing probe packets.  On hosts with more than one IP
             address, this option can be used to force the source address to be something other than the IP address of the interface the probe packet is sent on.  If the IP address
             is not one of this machine's interface addresses, an error is returned and nothing is sent.  (See the -i flag for another way to do this.) 



-S      Print a summary of how many probes were not answered for each hop.

     -t tos  Set the type-of-service in probe packets to the following value (default zero).  The value must be a decimal integer in the range 0 to 255.  This option can be used to
             see if different types-of-service result in different paths.  (If you are not running a 4.4BSD or later system, this may be academic since the normal network services
             like telnet and ftp don't let you control the TOS).  Not all values of TOS are legal or meaningful - see the IP spec for definitions.  Useful values are probably ‘-t
             16’ (low delay) and ‘-t 8’ (high throughput).

     -v      Verbose output.  Received ICMP packets other than TIME_EXCEEDED and UNREACHABLEs are listed.

     -w      Set the time (in seconds) to wait for a response to a probe (default 5 sec.).

     -x      Toggle IP checksums. Normally, this prevents traceroute from calculating IP checksums. In some cases, the operating system can overwrite parts of the outgoing packet
             but not recalculate the checksum (so in some cases the default is to not calculate checksums and using -x causes them to be calculated). Note that checksums are
             usually required for the last hop when using ICMP ECHO probes ( -I ). So they are always calculated when using ICMP.

     -z pausemsecs
             Set the time (in milliseconds) to pause between probes (default 0).  Some systems such as Solaris and routers such as Ciscos rate limit ICMP messages. A good value to
             use with this is 500 (e.g. 1/2 second).

     This program attempts to trace the route an IP packet would follow to some internet host by launching UDP probe packets with a small ttl (time to live) then listening for an
     ICMP &quot;time exceeded&quot; reply from a gateway.  We start our probes with a ttl of one and increase by one until we get an ICMP &quot;port unreachable&quot; (which means we got to &quot;host&quot;) or
     hit a max (which defaults to net.inet.ip.ttl hops &amp; can be changed with the -m flag).  Three probes (changed with -q flag) are sent at each ttl setting and a line is printed
     showing the ttl, address of the gateway and round trip time of each probe.  If the probe answers come from different gateways, the address of each responding system will be
     printed.  If there is no response within a 5 sec. timeout interval (changed with the -w flag), a &quot;*&quot; is printed for that probe.

     We don't want the destination host to process the UDP probe packets so the destination port is set to an unlikely value (if some clod on the destination is using that value,
     it can be changed with the -p flag).

     A sample use and output might be:

     [yak 71]% traceroute nis.nsf.net.
     traceroute to nis.nsf.net (35.1.1.48), 64 hops max, 38 byte packet
     1  helios.ee.lbl.gov (128.3.112.1)  19 ms  19 ms  0 ms
     2  lilac-dmc.Berkeley.EDU (128.32.216.1)  39 ms  39 ms  19 ms
     3  lilac-dmc.Berkeley.EDU (128.32.216.1)  39 ms  39 ms  19 ms
     4  ccngw-ner-cc.Berkeley.EDU (128.32.136.23)  39 ms  40 ms  39 ms
     5  ccn-nerif22.Berkeley.EDU (128.32.168.22)  39 ms  39 ms  39 ms
     6  128.32.197.4 (128.32.197.4)  40 ms  59 ms  59 ms
     7  131.119.2.5 (131.119.2.5)  59 ms  59 ms  59 ms
     8  129.140.70.13 (129.140.70.13)  99 ms  99 ms  80 ms
     9  129.140.71.6 (129.140.71.6)  139 ms  239 ms  319 ms
     10  129.140.81.7 (129.140.81.7)  220 ms  199 ms  199 ms
     11  nic.merit.edu (35.1.1.48)  239 ms  239 ms  239 ms

     Note that lines 2 &amp; 3 are the same.  This is due to a buggy kernel on the 2nd hop system - lbl-csam.arpa - that forwards packets with a zero ttl (a bug in the distributed
     version of 4.3 BSD).  Note that you have to guess what path the packets are taking cross-country since the NSFNet (129.140) doesn't supply address-to-name translations for its
     NSSes.

     A more interesting example is:

     [yak 72]% traceroute allspice.lcs.mit.edu.
     traceroute to allspice.lcs.mit.edu (18.26.0.115), 64 hops max
     1  helios.ee.lbl.gov (128.3.112.1)  0 ms  0 ms  0 ms
     2  lilac-dmc.Berkeley.EDU (128.32.216.1)  19 ms  19 ms  19 ms
     3  lilac-dmc.Berkeley.EDU (128.32.216.1)  39 ms  19 ms  19 ms
     4  ccngw-ner-cc.Berkeley.EDU (128.32.136.23)  19 ms  39 ms  39 ms
     5  ccn-nerif22.Berkeley.EDU (128.32.168.22)  20 ms  39 ms  39 ms
     6  128.32.197.4 (128.32.197.4)  59 ms  119 ms  39 ms
     7  131.119.2.5 (131.119.2.5)  59 ms  59 ms  39 ms
     8  129.140.70.13 (129.140.70.13)  80 ms  79 ms  99 ms
     9  129.140.71.6 (129.140.71.6)  139 ms  139 ms  159 ms

     10  129.140.81.7 (129.140.81.7)  199 ms  180 ms  300 ms
     11  129.140.72.17 (129.140.72.17)  300 ms  239 ms  239 ms
     12  * * *
     13  128.121.54.72 (128.121.54.72)  259 ms  499 ms  279 ms
     14  * * *
     15  * * *
     16  * * *
     17  * * *
     18  ALLSPICE.LCS.MIT.EDU (18.26.0.115)  339 ms  279 ms  279 ms

     Note that the gateways 12, 14, 15, 16 &amp; 17 hops away either don't send ICMP &quot;time exceeded&quot; messages or send them with a ttl too small to reach us.  14 - 17 are running the
     MIT C Gateway code that doesn't send &quot;time exceeded&quot;s.  God only knows what's going on with 12.

     The silent gateway 12 in the above may be the result of a bug in the 4.[23] BSD network code (and its derivatives):  4.x (x &lt;= 3) sends an unreachable message using whatever
     ttl remains in the original datagram.  Since, for gateways, the remaining ttl is zero, the ICMP &quot;time exceeded&quot; is guaranteed to not make it back to us.  The behavior of this
     bug is slightly more interesting when it appears on the destination system:

     1  helios.ee.lbl.gov (128.3.112.1)  0 ms  0 ms  0 ms
     2  lilac-dmc.Berkeley.EDU (128.32.216.1)  39 ms  19 ms  39 ms
     3  lilac-dmc.Berkeley.EDU (128.32.216.1)  19 ms  39 ms  19 ms
     4  ccngw-ner-cc.Berkeley.EDU (128.32.136.23)  39 ms  40 ms  19 ms
     5  ccn-nerif35.Berkeley.EDU (128.32.168.35)  39 ms  39 ms  39 ms
     6  csgw.Berkeley.EDU (128.32.133.254)  39 ms  59 ms  39 ms
     7  * * *
     8  * * *
     9  * * *
     10  * * *
     11  * * *
     12  * * *
     13  rip.Berkeley.EDU (128.32.131.22)  59 ms !  39 ms !  39 ms !
 Notice that there are 12 &quot;gateways&quot; (13 is the final destination) and exactly the last half of them are &quot;missing&quot;.  What's really happening is that rip (a Sun-3 running Sun
     OS3.5) is using the ttl from our arriving datagram as the ttl in its ICMP reply.  So, the reply will time out on the return path (with no notice sent to anyone since ICMP's
     aren't sent for ICMP's) until we probe with a ttl that's at least twice the path length.  I.e., rip is really only 7 hops away.  A reply that returns with a ttl of 1 is a clue
     this problem exists.  traceroute prints a &quot;!&quot; after the time if the ttl is &lt;= 1.  Since vendors ship a lot of obsolete (DEC´s Ultrix, Sun 3.x) or non-standard (HPUX) software,
     expect to see this problem frequently and/or take care picking the target host of your probes.

     Other possible annotations after the time are !H, !N, or !P (host, network or protocol unreachable), !S (source route failed), (fragmentation needed - the RFC1191 Path MTU
     Discovery value is displayed), !U or !W (destination network/host unknown), !I (source host is isolated), !A (communication with destination network administratively
     prohibited), !Z (communication with destination host administratively prohibited), !Q (for this ToS the destination network is unreachable), !T (for this ToS the destination
     host is unreachable), !X (communication administratively prohibited), !V (host precedence violation), !C (precedence cutoff in effect), or !&lt;num&gt; (ICMP unreachable code
     &lt;num&gt;).  These are defined by RFC1812 (which supersedes RFC1716).  If almost all the probes result in some kind of unreachable, traceroute will give up and exit.

     This program is intended for use in network testing, measurement and management.  It should be used primarily for manual fault isolation.  Because of the load it could impose
     on the network, it is unwise to use traceroute during normal operations or from automated scripts.

AUTHOR
     Implemented by Van Jacobson from a suggestion by Steve Deering.  Debugged by a cast of thousands with particularly cogent suggestions or fixes from C. Philip Wood, Tim Seaver
     and Ken Adelman.

SEE ALSO
     netstat(1), ping(8), traceroute6(8)

BUGS
     When using protocols other than UDP, functionality is reduced.  In particular, the last packet will often appear to be lost, because even though it reaches the destination
     host, there's no way to know that because no ICMP message is sent back.  In the TCP case, traceroute should listen for a RST from the destination host (or an intermediate
     router that's filtering packets), but this is not implemented yet.

     The AS number capability reports information that may sometimes be inaccurate due to discrepancies between the contents of the routing database server and the current state of
     the Internet.

BSD 4.3                                                                             May 29, 2008                                                                             BSD 4.3


</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="51-mctr"><a class="header" href="#51-mctr">5.1 mctr</a></h1>
<p>Here is my attempt on traceroute in python</p>
<pre><code class="language-py">

import os
import socket
import struct
import time
import argparse
import csv
from tabulate import tabulate

#-------------------------------------------------------------
# mctr.py
#
# author: mohan chinnappan
# copyleft software, maintain authors info in your copies
#_____________________________
# requires
# pip install tabulate
#_____________________________
# run it
# sudo python3 mctr.py --max-hops 30 --target  salesforce.com 

&quot;&quot;&quot;
sudo python3 mctr.py --target salesforce.com
Traceroute to salesforce.com (23.1.106.133), max 30 hops:
Saving results to salesforce.com.csv...
+-----+-----------------+------------------------------------------------------+-----------------------------+
| Hop |   IP Address    |                       Hostname                       |     Response Time (ms)      |
+-----+-----------------+------------------------------------------------------+-----------------------------+
|  1  |   192.168.1.1   |                       Unknown                        |            2 ms             |
|  2  |  100.93.14.67   |                       Unknown                        |            15 ms            |
|  3  |  96.110.31.153  |    po-313-412-rur102.exeter.nh.boston.comcast.net    |            14 ms            |
|  4  | 96.108.158.197  |       po-2-rur101.exeter.nh.boston.comcast.net       |            13 ms            |
|  5  | 162.151.151.225 |      po-100-xar01.exeter.nh.boston.comcast.net       |            15 ms            |
|  6  |        *        |                         N/A                          |     Request timed out.      |
|  7  |  162.151.52.34  |      be-501-ar01.needham.ma.boston.comcast.net       |            19 ms            |
|  8  |   68.86.90.66   |     be-1005-pe11.onesummer.ma.ibone.comcast.net      |            18 ms            |
|  9  |        *        |                         N/A                          |     Request timed out.      |
| 10  |  129.250.4.114  |         ae-6.r22.nwrknj03.us.bb.gin.ntt.net          |            26 ms            |
| 11  |        *        |                         N/A                          |     Request timed out.      |
| 12  |        *        |                         N/A                          |     Request timed out.      |
| 13  |  129.250.2.125  |         ae-1.a04.asbnva02.us.bb.gin.ntt.net          |            30 ms            |
| 14  | 129.250.194.70  |        ae-3.akamai.asbnva02.us.bb.gin.ntt.net        |            32 ms            |
| 15  | 184.51.101.116  | a184-51-101-116.deploy.static.akamaitechnologies.com |            28 ms            |
| 16  |        *        |                         N/A                          |     Request timed out.      |
| 17  | 23.203.153.144  |        ae17.r21.iad04.ien.netarch.akamai.com         |            28 ms            |
| 18  |  23.209.170.76  |         ae3.r22.iad04.mag.netarch.akamai.com         |            26 ms            |
| 19  |  23.209.170.81  |         ae3.r21.iad04.icn.netarch.akamai.com         |            27 ms            |
| 20  | 23.193.112.223  |        ae40.r01.ewr01.icn.netarch.akamai.com         |            32 ms            |
| 21  |   23.32.62.64   |         ae8.r01.bos02.icn.netarch.akamai.com         |            38 ms            |
| 22  |  23.203.149.43  |         ae8.r01.bos01.ien.netarch.akamai.com         |            51 ms            |
| 23  |        *        |                         N/A                          |     Request timed out.      |
| 24  |  23.1.106.133   |  a23-1-106-133.deploy.static.akamaitechnologies.com  | 29 ms (Destination Reached) |
+-----+-----------------+------------------------------------------------------+-----------------------------+
Traceroute complete. Results saved to salesforce.com.csv
#-------------------------------------------------------------
&quot;&quot;&quot;

ICMP_ECHO_REQUEST = 8  # ICMP type for Echo Request messages
TIMEOUT = 2  # Timeout for each hop in seconds

def checksum(packet):
    &quot;&quot;&quot;
    Calculate checksum of the packet.
    
    Args:
        packet (bytes): The packet for which checksum is calculated.

    Returns:
        int: The computed checksum.
    &quot;&quot;&quot;
    if len(packet) % 2 != 0:
        packet += b'\x00'

    s = sum(struct.unpack(&quot;!%dH&quot; % (len(packet) // 2), packet))
    s = (s &gt;&gt; 16) + (s &amp; 0xffff)
    s += s &gt;&gt; 16
    return ~s &amp; 0xffff


def create_icmp_packet(seq):
    &quot;&quot;&quot;
    Create an ICMP Echo Request packet.

    Args:
        seq (int): The sequence number for the packet.

    Returns:
        bytes: The constructed ICMP packet.
    &quot;&quot;&quot;
    header = struct.pack('!BBHHH', ICMP_ECHO_REQUEST, 0, 0, os.getpid() &amp; 0xFFFF, seq)
    data = struct.pack('d', time.time())  # Payload contains the current time
    packet_without_checksum = header + data
    packet_checksum = checksum(packet_without_checksum)
    header = struct.pack('!BBHHH', ICMP_ECHO_REQUEST, 0, packet_checksum, os.getpid() &amp; 0xFFFF, seq)
    return header + data


def traceroute(target, max_hops=30, timeout=TIMEOUT):
    &quot;&quot;&quot;
    Perform traceroute to a specified target with a set maximum number of hops and timeout.
    Output the result to both console and a CSV file.

    Args:
        target (str): The target hostname or IP address to trace.
        max_hops (int): The maximum number of hops allowed. Default is 30.
        timeout (int): Timeout in seconds for each hop. Default is 2.
    &quot;&quot;&quot;
    try:
        target_ip = socket.gethostbyname(target)
    except socket.gaierror as e:
        print(f&quot;Cannot resolve {target}: {e}&quot;)
        return

    # Generate output CSV filename based on target
    output_csv = f&quot;{target}.csv&quot;

    print(f&quot;Traceroute to {target} ({target_ip}), max {max_hops} hops:&quot;)
    print(f&quot;Saving results to {output_csv}...&quot;)

    # Table to collect results
    table = []
    headers = [&quot;Hop&quot;, &quot;IP Address&quot;, &quot;Hostname&quot;, &quot;Response Time (ms)&quot;]

    # CSV Output
    with open(output_csv, mode='w', newline='') as csvfile:
        csv_writer = csv.writer(csvfile)
        csv_writer.writerow(headers)  # Write the header row

        # Create a raw socket
        with socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_ICMP) as send_socket:
            send_socket.settimeout(timeout)

            for ttl in range(1, max_hops + 1):
                # Set the TTL (time-to-live)
                send_socket.setsockopt(socket.IPPROTO_IP, socket.IP_TTL, ttl)

                # Create ICMP Echo Request packet
                packet = create_icmp_packet(ttl)

                # Send the packet
                start_time = time.time()
                send_socket.sendto(packet, (target_ip, 1))

                try:
                    # Wait for a response
                    recv_socket = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_ICMP)
                    recv_socket.settimeout(timeout)

                    # Receive packet and sender address
                    recv_packet, addr = recv_socket.recvfrom(1024)
                    end_time = time.time()

                    icmp_header = recv_packet[20:28]
                    icmp_type, _, _, _, _ = struct.unpack(&quot;!BBHHH&quot;, icmp_header)

                    response_time = int((end_time - start_time) * 1000)

                    # Resolve hostname
                    try:
                        hostname = socket.gethostbyaddr(addr[0])[0]
                    except socket.herror:
                        hostname = &quot;Unknown&quot;

                    if icmp_type == 11:  # TTL Exceeded
                        row = [ttl, addr[0], hostname, f&quot;{response_time} ms&quot;]
                    elif icmp_type == 0:  # Echo Reply (Reached target)
                        row = [ttl, addr[0], hostname, f&quot;{response_time} ms (Destination Reached)&quot;]
                        table.append(row)
                        csv_writer.writerow(row)  # Write to CSV
                        break
                    else:
                        row = [ttl, &quot;*&quot;, &quot;N/A&quot;, &quot;Request timed out.&quot;]
                except socket.timeout:
                    row = [ttl, &quot;*&quot;, &quot;N/A&quot;, &quot;Request timed out.&quot;]
                finally:
                    recv_socket.close()

                # Add to both table and CSV
                table.append(row)
                csv_writer.writerow(row)

    # Print the results in table format
    print(tabulate(table, headers, tablefmt=&quot;pretty&quot;))
    print(f&quot;Traceroute complete. Results saved to {output_csv}&quot;)


def main():
    &quot;&quot;&quot;
    Main function to parse command line arguments and invoke the traceroute function.
    &quot;&quot;&quot;
    parser = argparse.ArgumentParser(description=&quot;Traceroute to a target with optional max hops and timeout.&quot;)
    parser.add_argument('--target', type=str, required=True, help=&quot;Target IP address or hostname&quot;)
    parser.add_argument('--max-hops', type=int, default=30, help=&quot;Maximum number of hops (default: 30)&quot;)
    parser.add_argument('--timeout', type=int, default=TIMEOUT, help=&quot;Timeout for each hop in seconds (default: 2)&quot;)
    args = parser.parse_args()

    # Ensure we are running with root privileges (for raw socket use)
    if os.geteuid() != 0:
        print(&quot;This script requires root privileges. Please run as root.&quot;)
        return

    traceroute(args.target, args.max_hops, args.timeout)


if __name__ == &quot;__main__&quot;:
    main()

</code></pre>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<pre><code>sudo python3 mctr.py --target apple.com 
Traceroute to apple.com (17.253.144.10), max 30 hops:
Saving results to apple.com.csv...
+-----+-----------------+------------------------------------------------+-----------------------------+
| Hop |   IP Address    |                    Hostname                    |     Response Time (ms)      |
+-----+-----------------+------------------------------------------------+-----------------------------+
|  1  |   192.168.1.1   |                    Unknown                     |            2 ms             |
|  2  |  100.93.14.66   |                    Unknown                     |            15 ms            |
|  3  |  96.110.31.137  | po-313-411-rur101.exeter.nh.boston.comcast.net |            15 ms            |
|  4  | 162.151.151.225 |   po-100-xar01.exeter.nh.boston.comcast.net    |            14 ms            |
|  5  |        *        |                      N/A                       |     Request timed out.      |
|  6  |  162.151.52.50  |   be-502-ar01.needham.ma.boston.comcast.net    |            21 ms            |
|  7  |  68.86.90.173   |  be-1003-pe02.onesummer.ma.ibone.comcast.net   |            18 ms            |
|  8  |        *        |                      N/A                       |     Request timed out.      |
|  9  |  17.253.144.10  |                  apple.com.do                  | 22 ms (Destination Reached) |
+-----+-----------------+------------------------------------------------+-----------------------------+
Traceroute complete. Results saved to apple.com.csv
</code></pre>
<pre><code>sudo python3 mctr.py --target facebook.com --timeout 5
Traceroute to facebook.com (157.240.245.35), max 30 hops:
Saving results to facebook.com.csv...
+-----+-----------------+------------------------------------------------+-----------------------------+
| Hop |   IP Address    |                    Hostname                    |     Response Time (ms)      |
+-----+-----------------+------------------------------------------------+-----------------------------+
|  1  |   192.168.1.1   |                    Unknown                     |            2 ms             |
|  2  |  100.93.14.67   |                    Unknown                     |            19 ms            |
|  3  |  96.110.31.153  | po-313-412-rur102.exeter.nh.boston.comcast.net |            19 ms            |
|  4  | 96.108.158.197  |    po-2-rur101.exeter.nh.boston.comcast.net    |            13 ms            |
|  5  | 162.151.151.225 |   po-100-xar01.exeter.nh.boston.comcast.net    |            14 ms            |
|  6  |        *        |                      N/A                       |     Request timed out.      |
|  7  |  162.151.52.34  |   be-501-ar01.needham.ma.boston.comcast.net    |            24 ms            |
|  8  |  96.113.72.238  |                    Unknown                     |            17 ms            |
|  9  |  129.134.33.76  |           po202.asw02.bos5.tfbnw.net           |            15 ms            |
| 10  | 129.134.87.221  |              psw04.bos5.tfbnw.net              |            17 ms            |
| 11  | 129.134.87.206  |            msw1aa.01.bos5.tfbnw.net            |            16 ms            |
| 12  | 157.240.245.35  |    edge-star-mini-shv-01-bos5.facebook.com     | 24 ms (Destination Reached) |
+-----+-----------------+------------------------------------------------+-----------------------------+
Traceroute complete. Results saved to facebook.com.csv

</code></pre>
<pre><code>sudo python3 mctr.py --target x.com --timeout 5
Traceroute to x.com (104.244.42.129), max 30 hops:
Saving results to x.com.csv...
+-----+-----------------+------------------------------------------------+-----------------------------+
| Hop |   IP Address    |                    Hostname                    |     Response Time (ms)      |
+-----+-----------------+------------------------------------------------+-----------------------------+
|  1  |   192.168.1.1   |                    Unknown                     |            2 ms             |
|  2  |  100.93.14.67   |                    Unknown                     |            15 ms            |
|  3  |  96.110.31.153  | po-313-412-rur102.exeter.nh.boston.comcast.net |            12 ms            |
|  4  | 96.108.158.197  |    po-2-rur101.exeter.nh.boston.comcast.net    |            15 ms            |
|  5  | 162.151.151.225 |   po-100-xar01.exeter.nh.boston.comcast.net    |            14 ms            |
|  6  |        *        |                      N/A                       |     Request timed out.      |
|  7  |  162.151.52.50  |   be-502-ar01.needham.ma.boston.comcast.net    |            30 ms            |
|  8  |        *        |                      N/A                       |     Request timed out.      |
|  9  |  4.69.227.138   |     ae1.3501.ear3.newyork6.net.lumen.tech      |            29 ms            |
| 10  |   4.38.173.30   |      twitter-inc.ear3.newyork6.level3.net      |            49 ms            |
| 11  |        *        |                      N/A                       |     Request timed out.      |
| 12  | 104.244.42.129  |                    Unknown                     | 52 ms (Destination Reached) |
+-----+-----------------+------------------------------------------------+-----------------------------+
</code></pre>
<h2 id="flow"><a class="header" href="#flow">FLow</a></h2>
<pre><code>+-------------------------+
| Start                   |
| (Run script)            |
+-------------------------+
            |
            v
+-------------------------+
| Check Root Privileges   |
| - Ensure script is run  |
|   with root privileges  |
|   (os.geteuid() != 0)   |
+-------------------------+
            |
            v
+-------------------------+
| Parse Command Line      |
| Arguments               |
| - --target              |
| - --max-hops            |
| - --timeout             |
+-------------------------+
            |
            v
+-------------------------+
| Resolve Target IP       |
| - Use socket.gethostbyname |
+-------------------------+
            |
            v
+-------------------------+
| Generate Output CSV     |
| - Filename: &lt;target&gt;.csv|
+-------------------------+
            |
            v
+-------------------------+
| Initialize Table and    |
| CSV Writer              |
| - Headers: Hop, IP Addr,|
|   Hostname, Resp Time   |
+-------------------------+
            |
            v
+-------------------------+
| For TTL from 1 to       |
| max_hops                |
+-------------------------+
            |
            v
+-------------------------+
| Set TTL and Create      |
| ICMP Packet             |
+-------------------------+
            |
            v
+-------------------------+
| Send ICMP Packet        |
| - Use raw socket        |
+-------------------------+
            |
            v
+-------------------------+
| Receive Response        |
| - Use raw socket        |
+-------------------------+
            |
            v
+-------------------------+
| Check ICMP Type         |
| - TTL Exceeded (11)     |
| - Echo Reply (0)        |
+-------------------------+
            |
            v
+-------------------------+
| Process Response        |
| - Calculate response    |
|   time                 |
| - Resolve Hostname      |
+-------------------------+
            |
            v
+-------------------------+
| Append Row to Table and |
| Write to CSV            |
| - Add Hop, IP Addr,     |
|   Hostname, Resp Time   |
+-------------------------+
            |
            v
+-------------------------+
| Check Completion        |
| - Echo Reply: Destination|
|   Reached               |
+-------------------------+
            |
            v
+-------------------------+
| Print Results           |
| - Display Table         |
| - Save CSV              |
+-------------------------+
            |
            v
+-------------------------+
| End                     |
+-------------------------+
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bsd-traceroute"><a class="header" href="#bsd-traceroute">bsd traceroute</a></h1>
<p>Here is the BSD <a href="https://github.com/openbsd/src/blob/master/usr.sbin/traceroute/traceroute.c">traceroute code</a>:</p>
<pre><code class="language-c">/*	$OpenBSD: traceroute.c,v 1.170 2024/08/21 15:00:25 florian Exp $	*/
/*	$NetBSD: traceroute.c,v 1.10 1995/05/21 15:50:45 mycroft Exp $	*/

/*
 * Copyright (C) 1995, 1996, 1997, and 1998 WIDE Project.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the project nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

/*-
 * Copyright (c) 1990, 1993
 *	The Regents of the University of California.  All rights reserved.
 *
 * This code is derived from software contributed to Berkeley by
 * Van Jacobson.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

/*
 * traceroute host  - trace the route ip packets follow going to &quot;host&quot;.
 *
 * Attempt to trace the route an ip packet would follow to some
 * internet host.  We find out intermediate hops by launching probe
 * packets with a small ttl (time to live) then listening for an
 * icmp &quot;time exceeded&quot; reply from a gateway.  We start our probes
 * with a ttl of one and increase by one until we get an icmp &quot;port
 * unreachable&quot; (which means we got to &quot;host&quot;) or hit a max (which
 * defaults to 64 hops &amp; can be changed with the -m flag).  Three
 * probes (change with -q flag) are sent at each ttl setting and a
 * line is printed showing the ttl, address of the gateway and
 * round trip time of each probe.  If the probe answers come from
 * different gateways, the address of each responding system will
 * be printed.  If there is no response within a 5 sec. timeout
 * interval (changed with the -w flag), a &quot;*&quot; is printed for that
 * probe.
 *
 * Probe packets are UDP format.  We don't want the destination
 * host to process them so the destination port is set to an
 * unlikely value (if some clod on the destination is using that
 * value, it can be changed with the -p flag).
 *
 * A sample use might be:
 *
 *     [yak 71]% traceroute nis.nsf.net.
 *     traceroute to nis.nsf.net (35.1.1.48), 64 hops max, 56 byte packet
 *      1  helios.ee.lbl.gov (128.3.112.1)  19 ms  19 ms  0 ms
 *      2  lilac-dmc.Berkeley.EDU (128.32.216.1)  39 ms  39 ms  19 ms
 *      3  lilac-dmc.Berkeley.EDU (128.32.216.1)  39 ms  39 ms  19 ms
 *      4  ccngw-ner-cc.Berkeley.EDU (128.32.136.23)  39 ms  40 ms  39 ms
 *      5  ccn-nerif22.Berkeley.EDU (128.32.168.22)  39 ms  39 ms  39 ms
 *      6  128.32.197.4 (128.32.197.4)  40 ms  59 ms  59 ms
 *      7  131.119.2.5 (131.119.2.5)  59 ms  59 ms  59 ms
 *      8  129.140.70.13 (129.140.70.13)  99 ms  99 ms  80 ms
 *      9  129.140.71.6 (129.140.71.6)  139 ms  239 ms  319 ms
 *     10  129.140.81.7 (129.140.81.7)  220 ms  199 ms  199 ms
 *     11  nic.merit.edu (35.1.1.48)  239 ms  239 ms  239 ms
 *
 * Note that lines 2 &amp; 3 are the same.  This is due to a buggy
 * kernel on the 2nd hop system -- lbl-csam.arpa -- that forwards
 * packets with a zero ttl.
 *
 * A more interesting example is:
 *
 *     [yak 72]% traceroute allspice.lcs.mit.edu.
 *     traceroute to allspice.lcs.mit.edu (18.26.0.115), 64 hops max
 *      1  helios.ee.lbl.gov (128.3.112.1)  0 ms  0 ms  0 ms
 *      2  lilac-dmc.Berkeley.EDU (128.32.216.1)  19 ms  19 ms  19 ms
 *      3  lilac-dmc.Berkeley.EDU (128.32.216.1)  39 ms  19 ms  19 ms
 *      4  ccngw-ner-cc.Berkeley.EDU (128.32.136.23)  19 ms  39 ms  39 ms
 *      5  ccn-nerif22.Berkeley.EDU (128.32.168.22)  20 ms  39 ms  39 ms
 *      6  128.32.197.4 (128.32.197.4)  59 ms  119 ms  39 ms
 *      7  131.119.2.5 (131.119.2.5)  59 ms  59 ms  39 ms
 *      8  129.140.70.13 (129.140.70.13)  80 ms  79 ms  99 ms
 *      9  129.140.71.6 (129.140.71.6)  139 ms  139 ms  159 ms
 *     10  129.140.81.7 (129.140.81.7)  199 ms  180 ms  300 ms
 *     11  129.140.72.17 (129.140.72.17)  300 ms  239 ms  239 ms
 *     12  * * *
 *     13  128.121.54.72 (128.121.54.72)  259 ms  499 ms  279 ms
 *     14  * * *
 *     15  * * *
 *     16  * * *
 *     17  * * *
 *     18  ALLSPICE.LCS.MIT.EDU (18.26.0.115)  339 ms  279 ms  279 ms
 *
 * (I start to see why I'm having so much trouble with mail to
 * MIT.)  Note that the gateways 12, 14, 15, 16 &amp; 17 hops away
 * either don't send ICMP &quot;time exceeded&quot; messages or send them
 * with a ttl too small to reach us.  14 - 17 are running the
 * MIT C Gateway code that doesn't send &quot;time exceeded&quot;s.  God
 * only knows what's going on with 12.
 *
 * The silent gateway 12 in the above may be the result of a bug in
 * the 4.[23]BSD network code (and its derivatives):  4.x (x &lt;= 3)
 * sends an unreachable message using whatever ttl remains in the
 * original datagram.  Since, for gateways, the remaining ttl is
 * zero, the icmp &quot;time exceeded&quot; is guaranteed to not make it back
 * to us.  The behavior of this bug is slightly more interesting
 * when it appears on the destination system:
 *
 *      1  helios.ee.lbl.gov (128.3.112.1)  0 ms  0 ms  0 ms
 *      2  lilac-dmc.Berkeley.EDU (128.32.216.1)  39 ms  19 ms  39 ms
 *      3  lilac-dmc.Berkeley.EDU (128.32.216.1)  19 ms  39 ms  19 ms
 *      4  ccngw-ner-cc.Berkeley.EDU (128.32.136.23)  39 ms  40 ms  19 ms
 *      5  ccn-nerif35.Berkeley.EDU (128.32.168.35)  39 ms  39 ms  39 ms
 *      6  csgw.Berkeley.EDU (128.32.133.254)  39 ms  59 ms  39 ms
 *      7  * * *
 *      8  * * *
 *      9  * * *
 *     10  * * *
 *     11  * * *
 *     12  * * *
 *     13  rip.Berkeley.EDU (128.32.131.22)  59 ms !  39 ms !  39 ms !
 *
 * Notice that there are 12 &quot;gateways&quot; (13 is the final
 * destination) and exactly the last half of them are &quot;missing&quot;.
 * What's really happening is that rip (a Sun-3 running Sun OS3.5)
 * is using the ttl from our arriving datagram as the ttl in its
 * icmp reply.  So, the reply will time out on the return path
 * (with no notice sent to anyone since icmp's aren't sent for
 * icmp's) until we probe with a ttl that's at least twice the path
 * length.  I.e., rip is really only 7 hops away.  A reply that
 * returns with a ttl of 1 is a clue this problem exists.
 * Traceroute prints a &quot;!&quot; after the time if the ttl is &lt;= 1.
 * Since vendors ship a lot of obsolete (DEC's Ultrix, Sun 3.x) or
 * non-standard (HPUX) software, expect to see this problem
 * frequently and/or take care picking the target host of your
 * probes.
 *
 * Other possible annotations after the time are !H, !N, !P (got a host,
 * network or protocol unreachable, respectively), !S or !F (source
 * route failed or fragmentation needed -- neither of these should
 * ever occur and the associated gateway is busted if you see one).  If
 * almost all the probes result in some kind of unreachable, traceroute
 * will give up and exit.
 *
 * Notes
 * -----
 * This program must be run by root or be setuid.  (I suggest that
 * you *don't* make it setuid -- casual use could result in a lot
 * of unnecessary traffic on our poor, congested nets.)
 *
 * This program requires a kernel mod that does not appear in any
 * system available from Berkeley:  A raw ip socket using proto
 * IPPROTO_RAW must interpret the data sent as an ip datagram (as
 * opposed to data to be wrapped in a ip datagram).  See the README
 * file that came with the source to this program for a description
 * of the mods I made to /sys/netinet/raw_ip.c.  Your mileage may
 * vary.  But, again, ANY 4.x (x &lt; 4) BSD KERNEL WILL HAVE TO BE
 * MODIFIED TO RUN THIS PROGRAM.
 *
 * The udp port usage may appear bizarre (well, ok, it is bizarre).
 * The problem is that an icmp message only contains 8 bytes of
 * data from the original datagram.  8 bytes is the size of a udp
 * header so, if we want to associate replies with the original
 * datagram, the necessary information must be encoded into the
 * udp header (the ip id could be used but there's no way to
 * interlock with the kernel's assignment of ip id's and, anyway,
 * it would have taken a lot more kernel hacking to allow this
 * code to set the ip id).  So, to allow two or more users to
 * use traceroute simultaneously, we use this task's pid as the
 * source port (the high bit is set to move the port number out
 * of the &quot;likely&quot; range).  To keep track of which probe is being
 * replied to (so times and/or hop counts don't get confused by a
 * reply that was delayed in transit), we increment the destination
 * port number before each probe.
 *
 * Don't use this as a coding example.  I was trying to find a
 * routing problem and this code sort-of popped out after 48 hours
 * without sleep.  I was amazed it ever compiled, much less ran.
 *
 * I stole the idea for this program from Steve Deering.  Since
 * the first release, I've learned that had I attended the right
 * IETF working group meetings, I also could have stolen it from Guy
 * Almes or Matt Mathis.  I don't know (or care) who came up with
 * the idea first.  I envy the originators' perspicacity and I'm
 * glad they didn't keep the idea a secret.
 *
 * Tim Seaver, Ken Adelman and C. Philip Wood provided bug fixes and/or
 * enhancements to the original distribution.
 *
 * I've hacked up a round-trip-route version of this that works by
 * sending a loose-source-routed udp datagram through the destination
 * back to yourself.  Unfortunately, SO many gateways botch source
 * routing, the thing is almost worthless.  Maybe one day...
 *
 *  -- Van Jacobson (van@helios.ee.lbl.gov)
 *     Tue Dec 20 03:50:13 PST 1988
 */

#include &lt;sys/socket.h&gt;
#include &lt;sys/sysctl.h&gt;
#include &lt;sys/time.h&gt;
#include &lt;sys/uio.h&gt;

#include &lt;netinet/in.h&gt;
#include &lt;netinet/ip.h&gt;
#include &lt;netinet/ip6.h&gt;
#include &lt;netinet/ip_icmp.h&gt;
#include &lt;netinet/icmp6.h&gt;
#include &lt;netinet/udp.h&gt;

#include &lt;arpa/inet.h&gt;

#include &lt;err.h&gt;
#include &lt;errno.h&gt;
#include &lt;event.h&gt;
#include &lt;limits.h&gt;
#include &lt;netdb.h&gt;
#include &lt;pwd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;

#include &quot;traceroute.h&quot;

int32_t	 sec_perturb;
int32_t	 usec_perturb;

u_char	 packet[512];
u_char	*outpacket;	/* last inbound (icmp) packet */

int	rcvsock;	/* receive (icmp) socket file descriptor */
int	sndsock;	/* send (udp) socket file descriptor */

int	rcvhlim;
struct in6_pktinfo *rcvpktinfo;

int	datalen;	/* How much data */

char	*hostname;

u_int16_t	srcport;

void	usage(void);

#define	TRACEROUTE_USER	&quot;_traceroute&quot;

void	sock_read(int, short, void *);
void	send_timer(int, short, void *);

struct tr_conf		*conf;	/* configuration defaults */
struct tr_result	*tr_results;
struct sockaddr_in	 from4, to4;
struct sockaddr_in6	 from6, to6;
struct sockaddr		*from, *to;
struct msghdr		 rcvmhdr;
struct event		 timer_ev;
int			 v6flag;
int			*waiting_ttls;
int			 last_tos = 0;

int
main(int argc, char *argv[])
{
	int	mib[4] = { CTL_NET, PF_INET, IPPROTO_IP, IPCTL_DEFTTL };
	char	hbuf[NI_MAXHOST];

	struct addrinfo		 hints, *res;
	struct ip		*ip = NULL;
	struct iovec		 rcviov[2];
	static u_char		*rcvcmsgbuf;
	struct passwd		*pw;
	struct event		 sock_ev;
	struct timeval		tv = {0, 0};

	long		 l;
	socklen_t	 len;
	size_t		 size;

	int		 ch;
	int		 on = 1;
	int		 error;
	int		 headerlen;	/* How long packet's header is */
	int		 i;
	int		 packetlen;
	int		 rcvcmsglen;
	int		 rcvsock4, rcvsock6;
	int		 sndsock4, sndsock6;
	u_int32_t	 tmprnd;
	int		 v4sock_errno, v6sock_errno;

	char		*dest;
	const char	*errstr;

	uid_t		 ouid, uid;
	gid_t		 gid;

	/* Cannot pledge due to special setsockopt()s below */
	if (unveil(&quot;/&quot;, &quot;r&quot;) == -1)
		err(1, &quot;unveil /&quot;);
	if (unveil(NULL, NULL) == -1)
		err(1, &quot;unveil&quot;);

	if ((conf = calloc(1, sizeof(*conf))) == NULL)
		err(1,NULL);

	conf-&gt;first_ttl = 1;
	conf-&gt;proto = IPPROTO_UDP;
	conf-&gt;max_ttl = IPDEFTTL;
	conf-&gt;nprobes = 3;
	conf-&gt;expected_responses = 2; /* icmp + DNS */

	/* start udp dest port # for probe packets */
	conf-&gt;port = 32768+666;

	memset(&amp;rcvmhdr, 0, sizeof(rcvmhdr));
	memset(&amp;rcviov, 0, sizeof(rcviov));

	rcvsock4 = rcvsock6 = sndsock4 = sndsock6 = -1;
	v4sock_errno = v6sock_errno = 0;

	conf-&gt;waittime = 3 * 1000;

	if ((rcvsock6 = socket(AF_INET6, SOCK_RAW, IPPROTO_ICMPV6)) == -1)
		v6sock_errno = errno;
	else if ((sndsock6 = socket(AF_INET6, SOCK_DGRAM, 0)) == -1)
		v6sock_errno = errno;

	if ((rcvsock4 = socket(AF_INET, SOCK_RAW, IPPROTO_ICMP)) == -1)
		v4sock_errno = errno;
	else if ((sndsock4 = socket(AF_INET, SOCK_RAW, IPPROTO_RAW)) == -1)
		v4sock_errno = errno;

	/* revoke privs */
	ouid = getuid();
	if (ouid == 0 &amp;&amp; (pw = getpwnam(TRACEROUTE_USER)) != NULL) {
		uid = pw-&gt;pw_uid;
		gid = pw-&gt;pw_gid;
	} else {
		uid = getuid();
		gid = getgid();
	}
	if (ouid &amp;&amp; (setgroups(1, &amp;gid) ||
	    setresgid(gid, gid, gid) ||
	    setresuid(uid, uid, uid)))
		err(1, &quot;unable to revoke privs&quot;);

	if (strcmp(&quot;traceroute6&quot;, __progname) == 0) {
		v6flag = 1;
		if (v6sock_errno != 0)
			errc(5, v6sock_errno, rcvsock6 &lt; 0 ? &quot;socket(ICMPv6)&quot; :
			    &quot;socket(SOCK_DGRAM)&quot;);
		rcvsock = rcvsock6;
		sndsock = sndsock6;
		if (rcvsock4 &gt;= 0)
			close(rcvsock4);
		if (sndsock4 &gt;= 0)
			close(sndsock4);
	} else {
		if (v4sock_errno != 0)
			errc(5, v4sock_errno, rcvsock4 &lt; 0 ? &quot;icmp socket&quot; :
			    &quot;raw socket&quot;);
		rcvsock = rcvsock4;
		sndsock = sndsock4;
		if (rcvsock6 &gt;= 0)
			close(rcvsock6);
		if (sndsock6 &gt;= 0)
			close(sndsock6);
	}

	if (v6flag) {
		mib[1] = PF_INET6;
		mib[2] = IPPROTO_IPV6;
		mib[3] = IPV6CTL_DEFHLIM;
		/* specify to tell receiving interface */
		if (setsockopt(rcvsock, IPPROTO_IPV6, IPV6_RECVPKTINFO, &amp;on,
		    sizeof(on)) == -1)
			err(1, &quot;setsockopt(IPV6_RECVPKTINFO)&quot;);

		/* specify to tell hoplimit field of received IP6 hdr */
		if (setsockopt(rcvsock, IPPROTO_IPV6, IPV6_RECVHOPLIMIT, &amp;on,
		    sizeof(on)) == -1)
			err(1, &quot;setsockopt(IPV6_RECVHOPLIMIT)&quot;);
	}

	size = sizeof(i);
	if (sysctl(mib, sizeof(mib)/sizeof(mib[0]), &amp;i, &amp;size, NULL, 0) == -1)
		err(1, &quot;sysctl&quot;);
	conf-&gt;max_ttl = i;

	while ((ch = getopt(argc, argv, v6flag ? &quot;ADdf:Ilm:np:q:Ss:t:w:vV:&quot; :
	    &quot;ADdf:g:Ilm:nP:p:q:Ss:t:V:vw:x&quot;)) != -1)
		switch (ch) {
		case 'A':
			conf-&gt;Aflag = 1;
			conf-&gt;expected_responses++;
			break;
		case 'd':
			conf-&gt;dflag = 1;
			break;
		case 'D':
			conf-&gt;dump = 1;
			break;
		case 'f':
			conf-&gt;first_ttl = strtonum(optarg, 1, conf-&gt;max_ttl,
			    &amp;errstr);
			if (errstr)
				errx(1, &quot;min ttl must be 1 to %u.&quot;,
				    conf-&gt;max_ttl);
			break;
		case 'g':
			if (conf-&gt;lsrr &gt;= MAX_LSRR)
				errx(1, &quot;too many gateways; max %d&quot;, MAX_LSRR);
			memset(&amp;hints, 0, sizeof(hints));
			hints.ai_family = AF_INET;

			if (getaddrinfo(optarg, NULL, &amp;hints, &amp;res) != 0)
				errx(1, &quot;unknown host %s&quot;, optarg);

			conf-&gt;gateway[conf-&gt;lsrr] =
			    ((struct sockaddr_in *)res-&gt;ai_addr)-&gt;sin_addr;
			freeaddrinfo(res);

			if (++conf-&gt;lsrr == 1)
				conf-&gt;lsrrlen = 4;
			conf-&gt;lsrrlen += 4;
			break;
		case 'I':
			if (conf-&gt;protoset)
				errx(1, &quot;protocol already set with -P&quot;);
			conf-&gt;protoset = 1;
			conf-&gt;proto = IPPROTO_ICMP;
			break;
		case 'l':
			conf-&gt;ttl_flag = 1;
			break;
		case 'm':
			conf-&gt;max_ttl = strtonum(optarg, conf-&gt;first_ttl,
			    MAXTTL, &amp;errstr);
			if (errstr)
				errx(1, &quot;max ttl must be %u to %u.&quot;,
				    conf-&gt;first_ttl, MAXTTL);
			break;
		case 'n':
			conf-&gt;nflag = 1;
			conf-&gt;expected_responses--;
			break;
		case 'p':
			conf-&gt;port = strtonum(optarg, 1, 65535, &amp;errstr);
			if (errstr)
				errx(1, &quot;port must be &gt;0, &lt;65536.&quot;);
			break;
		case 'P':
			if (conf-&gt;protoset)
				errx(1, &quot;protocol already set with -I&quot;);
			conf-&gt;protoset = 1;
			conf-&gt;proto = strtonum(optarg, 1, IPPROTO_MAX - 1,
			    &amp;errstr);
			if (errstr) {
				struct protoent *pent;

				pent = getprotobyname(optarg);
				if (pent)
					conf-&gt;proto = pent-&gt;p_proto;
				else
					errx(1, &quot;proto must be &gt;=1, or a &quot;
					    &quot;name.&quot;);
			}
			break;
		case 'q':
			conf-&gt;nprobes = strtonum(optarg, 1, 1024, &amp;errstr);
			if (errstr)
				errx(1, &quot;nprobes must be &gt;0.&quot;);
			break;
		case 's':
			/*
			 * set the ip source address of the outbound
			 * probe (e.g., on a multi-homed host).
			 */
			conf-&gt;source = optarg;
			break;
		case 'S':
			conf-&gt;sump = 1;
			break;
		case 't':
			if (!map_tos(optarg, &amp;conf-&gt;tos)) {
				if (strlen(optarg) &gt; 1 &amp;&amp; optarg[0] == '0' &amp;&amp;
				    optarg[1] == 'x') {
					char *ep;
					errno = 0;
					ep = NULL;
					l = strtol(optarg, &amp;ep, 16);
					if (errno || !*optarg || *ep ||
					    l &lt; 0 || l &gt; 255)
						errx(1, &quot;illegal tos value %s&quot;,
						    optarg);
					conf-&gt;tos = (int)l;
				} else {
					conf-&gt;tos = strtonum(optarg, 0, 255,
					    &amp;errstr);
					if (errstr)
						errx(1, &quot;illegal tos value %s&quot;,
						    optarg);
				}
			}
			conf-&gt;tflag = 1;
			last_tos = conf-&gt;tos;
			break;
		case 'v':
			conf-&gt;verbose = 1;
			break;
		case 'V':
			conf-&gt;rtableid = (unsigned int)strtonum(optarg, 0,
			    RT_TABLEID_MAX, &amp;errstr);
			if (errstr)
				errx(1, &quot;rtable value is %s: %s&quot;,
				    errstr, optarg);
			if (setsockopt(sndsock, SOL_SOCKET, SO_RTABLE,
			    &amp;conf-&gt;rtableid, sizeof(conf-&gt;rtableid)) == -1)
				err(1, &quot;setsockopt SO_RTABLE&quot;);
			if (setsockopt(rcvsock, SOL_SOCKET, SO_RTABLE,
			    &amp;conf-&gt;rtableid, sizeof(conf-&gt;rtableid)) == -1)
				err(1, &quot;setsockopt SO_RTABLE&quot;);
			break;
		case 'w':
			conf-&gt;waittime = strtonum(optarg, 1, INT_MAX, &amp;errstr);
			if (errstr)
				errx(1, &quot;wait must be &gt;=1 sec.&quot;);
			conf-&gt;waittime *= 1000;
			break;
		case 'x':
			conf-&gt;xflag = 1;
			break;
		default:
			usage();
		}

	if (ouid == 0 &amp;&amp; (setgroups(1, &amp;gid) ||
	    setresgid(gid, gid, gid) ||
	    setresuid(uid, uid, uid)))
		err(1, &quot;unable to revoke privs&quot;);

	argc -= optind;
	argv += optind;

	if (argc &lt; 1 || argc &gt; 2)
		usage();

	tr_results = calloc(sizeof(struct tr_result), conf-&gt;max_ttl *
	    conf-&gt;nprobes);
	if (tr_results == NULL)
		err(1, NULL);

	waiting_ttls = calloc(sizeof(int), conf-&gt;max_ttl);
	for (i = 0; i &lt; conf-&gt;max_ttl; i++)
		waiting_ttls[i] = conf-&gt;nprobes * conf-&gt;expected_responses;

	setvbuf(stdout, NULL, _IOLBF, 0);

	conf-&gt;ident = (getpid() &amp; 0xffff) | 0x8000;
	tmprnd = arc4random();
	sec_perturb = (tmprnd &amp; 0x80000000) ? -(tmprnd &amp; 0x7ff) :
	    (tmprnd &amp; 0x7ff);
	usec_perturb = arc4random();

	memset(&amp;to4, 0, sizeof(to4));
	memset(&amp;to6, 0, sizeof(to6));

	dest = *argv;

	memset(&amp;hints, 0, sizeof(hints));
	hints.ai_family = v6flag ? PF_INET6 : PF_INET;
	hints.ai_socktype = SOCK_RAW;
	hints.ai_protocol = 0;
	hints.ai_flags = AI_CANONNAME;
	if ((error = getaddrinfo(dest, NULL, &amp;hints, &amp;res)))
		errx(1, &quot;%s&quot;, gai_strerror(error));

	switch (res-&gt;ai_family) {
	case AF_INET:
		to = (struct sockaddr *)&amp;to4;
		from = (struct sockaddr *)&amp;from4;
		break;
	case AF_INET6:
		to = (struct sockaddr *)&amp;to6;
		from = (struct sockaddr *)&amp;from6;
		break;
	default:
		errx(1, &quot;unsupported AF: %d&quot;, res-&gt;ai_family);
		break;
	}

	memcpy(to, res-&gt;ai_addr, res-&gt;ai_addrlen);

	if (!hostname) {
		hostname = res-&gt;ai_canonname ? strdup(res-&gt;ai_canonname) : dest;
		if (!hostname)
			errx(1, &quot;malloc&quot;);
	}

	if (res-&gt;ai_next) {
		if (getnameinfo(res-&gt;ai_addr, res-&gt;ai_addrlen, hbuf,
		    sizeof(hbuf), NULL, 0, NI_NUMERICHOST) != 0)
			strlcpy(hbuf, &quot;?&quot;, sizeof(hbuf));
		warnx(&quot;Warning: %s has multiple &quot;
		    &quot;addresses; using %s&quot;, hostname, hbuf);
	}
	freeaddrinfo(res);

	if (*++argv) {
		datalen = strtonum(*argv, 0, INT_MAX, &amp;errstr);
		if (errstr)
			errx(1, &quot;datalen out of range&quot;);
	}

	switch (to-&gt;sa_family) {
	case AF_INET:
		switch (conf-&gt;proto) {
		case IPPROTO_UDP:
			headerlen = (sizeof(struct ip) + conf-&gt;lsrrlen +
			    sizeof(struct udphdr) + sizeof(struct packetdata));
			break;
		case IPPROTO_ICMP:
			headerlen = (sizeof(struct ip) + conf-&gt;lsrrlen +
			    sizeof(struct icmp) + sizeof(struct packetdata));
			break;
		default:
			headerlen = (sizeof(struct ip) + conf-&gt;lsrrlen +
			    sizeof(struct packetdata));
		}

		if (datalen &lt; 0 || datalen &gt; IP_MAXPACKET - headerlen)
			errx(1, &quot;packet size must be 0 to %d.&quot;,
			    IP_MAXPACKET - headerlen);

		datalen += headerlen;

		if ((outpacket = calloc(1, datalen)) == NULL)
			err(1, &quot;calloc&quot;);

		rcviov[0].iov_base = (caddr_t)packet;
		rcviov[0].iov_len = sizeof(packet);
		rcvmhdr.msg_name = (caddr_t)&amp;from4;
		rcvmhdr.msg_namelen = sizeof(from4);
		rcvmhdr.msg_iov = rcviov;
		rcvmhdr.msg_iovlen = 1;
		rcvmhdr.msg_control = NULL;
		rcvmhdr.msg_controllen = 0;

		ip = (struct ip *)outpacket;
		if (conf-&gt;lsrr != 0) {
			u_char *p = (u_char *)(ip + 1);

			*p++ = IPOPT_NOP;
			*p++ = IPOPT_LSRR;
			*p++ = conf-&gt;lsrrlen - 1;
			*p++ = IPOPT_MINOFF;
			conf-&gt;gateway[conf-&gt;lsrr] = to4.sin_addr;
			for (i = 1; i &lt;= conf-&gt;lsrr; i++) {
				memcpy(p, &amp;conf-&gt;gateway[i],
				    sizeof(struct in_addr));
				p += sizeof(struct in_addr);
			}
			ip-&gt;ip_dst = conf-&gt;gateway[0];
		} else
			ip-&gt;ip_dst = to4.sin_addr;
		ip-&gt;ip_off = htons(0);
		ip-&gt;ip_hl = (sizeof(struct ip) + conf-&gt;lsrrlen) &gt;&gt; 2;
		ip-&gt;ip_p = conf-&gt;proto;
		ip-&gt;ip_v = IPVERSION;
		ip-&gt;ip_tos = conf-&gt;tos;

		if (setsockopt(sndsock, IPPROTO_IP, IP_HDRINCL,
		    &amp;on, sizeof(on)) == -1)
			err(6, &quot;IP_HDRINCL&quot;);

		if (conf-&gt;source) {
			memset(&amp;from4, 0, sizeof(from4));
			from4.sin_family = AF_INET;
			if (inet_pton(AF_INET, conf-&gt;source, &amp;from4.sin_addr)
			    != 1)
				errx(1, &quot;unknown host %s&quot;, conf-&gt;source);
			ip-&gt;ip_src = from4.sin_addr;
			if (ouid != 0 &amp;&amp;
			    (ntohl(from4.sin_addr.s_addr) &amp; 0xff000000U) ==
			    0x7f000000U &amp;&amp; (ntohl(to4.sin_addr.s_addr) &amp;
			    0xff000000U) != 0x7f000000U)
				errx(1, &quot;source is on 127/8, destination is&quot;
				    &quot; not&quot;);
			if (ouid &amp;&amp; bind(sndsock, (struct sockaddr *)&amp;from4,
			    sizeof(from4)) == -1)
				err(1, &quot;bind&quot;);
		}
		packetlen = datalen;
		break;
	case AF_INET6:
		/*
		 * packetlen is the size of the complete IP packet sent and
		 * reported in the first line of output.
		 * For IPv4 this is equal to datalen since we are constructing
		 * a raw packet.
		 * For IPv6 we need to always add the size of the IP6 header
		 * and for UDP packets the size of the UDP header since they
		 * are prepended to the packet by the kernel
		 */
		packetlen = sizeof(struct ip6_hdr);
		switch (conf-&gt;proto) {
		case IPPROTO_UDP:
			headerlen = sizeof(struct packetdata);
			packetlen += sizeof(struct udphdr);
			break;
		case IPPROTO_ICMP:
			headerlen = sizeof(struct icmp6_hdr) +
			    sizeof(struct packetdata);
			break;
		default:
			errx(1, &quot;Unsupported proto: %hhu&quot;, conf-&gt;proto);
			break;
		}

		if (datalen &lt; 0 || datalen &gt; IP_MAXPACKET - headerlen)
			errx(1, &quot;packet size must be 0 to %d.&quot;,
			    IP_MAXPACKET - headerlen);

		datalen += headerlen;
		packetlen += datalen;

		if ((outpacket = calloc(1, datalen)) == NULL)
			err(1, &quot;calloc&quot;);

		/* initialize msghdr for receiving packets */
		rcviov[0].iov_base = (caddr_t)packet;
		rcviov[0].iov_len = sizeof(packet);
		rcvmhdr.msg_name = (caddr_t)&amp;from6;
		rcvmhdr.msg_namelen = sizeof(from6);
		rcvmhdr.msg_iov = rcviov;
		rcvmhdr.msg_iovlen = 1;
		rcvcmsglen = CMSG_SPACE(sizeof(struct in6_pktinfo)) +
		    CMSG_SPACE(sizeof(int));

		if ((rcvcmsgbuf = malloc(rcvcmsglen)) == NULL)
			errx(1, &quot;malloc&quot;);
		rcvmhdr.msg_control = (caddr_t) rcvcmsgbuf;
		rcvmhdr.msg_controllen = rcvcmsglen;

		/*
		 * Send UDP or ICMP
		 */
		if (conf-&gt;proto == IPPROTO_ICMP) {
			close(sndsock);
			sndsock = rcvsock;
		}

		/*
		 * Source selection
		 */
		memset(&amp;from6, 0, sizeof(from6));
		if (conf-&gt;source) {
			memset(&amp;hints, 0, sizeof(hints));
			hints.ai_family = AF_INET6;
			hints.ai_socktype = SOCK_DGRAM;	/*dummy*/
			hints.ai_flags = AI_NUMERICHOST;
			if ((error = getaddrinfo(conf-&gt;source, &quot;0&quot;, &amp;hints,
			    &amp;res)))
				errx(1, &quot;%s: %s&quot;, conf-&gt;source,
				    gai_strerror(error));
			memcpy(&amp;from6, res-&gt;ai_addr, res-&gt;ai_addrlen);
			freeaddrinfo(res);
		} else {
			struct sockaddr_in6 nxt;
			int dummy;

			nxt = to6;
			nxt.sin6_port = htons(DUMMY_PORT);
			if ((dummy = socket(AF_INET6, SOCK_DGRAM, 0)) == -1)
				err(1, &quot;socket&quot;);
			if (conf-&gt;rtableid &gt; 0 &amp;&amp;
			    setsockopt(dummy, SOL_SOCKET, SO_RTABLE,
			    &amp;conf-&gt;rtableid, sizeof(conf-&gt;rtableid)) == -1)
				err(1, &quot;setsockopt(SO_RTABLE)&quot;);
			if (connect(dummy, (struct sockaddr *)&amp;nxt,
			    nxt.sin6_len) == -1)
				err(1, &quot;connect&quot;);
			len = sizeof(from6);
			if (getsockname(dummy, (struct sockaddr *)&amp;from6,
			    &amp;len) == -1)
				err(1, &quot;getsockname&quot;);
			close(dummy);
		}

		from6.sin6_port = htons(0);
		if (bind(sndsock, (struct sockaddr *)&amp;from6, from6.sin6_len) == -1)
			err(1, &quot;bind sndsock&quot;);

		if (conf-&gt;tflag) {
			if (setsockopt(sndsock, IPPROTO_IPV6, IPV6_TCLASS,
			    &amp;conf-&gt;tos, sizeof(conf-&gt;tos)) == -1)
				err(6, &quot;IPV6_TCLASS&quot;);
		}

		len = sizeof(from6);
		if (getsockname(sndsock, (struct sockaddr *)&amp;from6, &amp;len) == -1)
			err(1, &quot;getsockname&quot;);
		srcport = ntohs(from6.sin6_port);
		break;
	default:
		errx(1, &quot;unsupported AF: %d&quot;, to-&gt;sa_family);
		break;
	}

	if (conf-&gt;dflag) {
		(void) setsockopt(rcvsock, SOL_SOCKET, SO_DEBUG,
		    &amp;on, sizeof(on));
		(void) setsockopt(sndsock, SOL_SOCKET, SO_DEBUG,
		    &amp;on, sizeof(on));
	}

	if (setsockopt(sndsock, SOL_SOCKET, SO_SNDBUF,
	    &amp;datalen, sizeof(datalen)) == -1)
		err(6, &quot;SO_SNDBUF&quot;);

	if (conf-&gt;nflag &amp;&amp; !conf-&gt;Aflag) {
		if (pledge(&quot;stdio inet&quot;, NULL) == -1)
			err(1, &quot;pledge&quot;);
	} else {
		if (pledge(&quot;stdio inet dns&quot;, NULL) == -1)
			err(1, &quot;pledge&quot;);
	}

	if (getnameinfo(to, to-&gt;sa_len, hbuf,
	    sizeof(hbuf), NULL, 0, NI_NUMERICHOST))
		strlcpy(hbuf, &quot;(invalid)&quot;, sizeof(hbuf));
	fprintf(stderr, &quot;%s to %s (%s)&quot;, __progname, hostname, hbuf);
	if (conf-&gt;source)
		fprintf(stderr, &quot; from %s&quot;, conf-&gt;source);
	fprintf(stderr, &quot;, %u hops max, %d byte packets\n&quot;, conf-&gt;max_ttl,
	    packetlen);
	(void) fflush(stderr);

	if (conf-&gt;first_ttl &gt; 1)
		printf(&quot;Skipping %u intermediate hops\n&quot;, conf-&gt;first_ttl - 1);

	event_init();

	event_set(&amp;sock_ev, rcvsock, EV_READ | EV_PERSIST, sock_read, NULL);
	event_add(&amp;sock_ev, NULL);
	evtimer_set(&amp;timer_ev, send_timer, &amp;timer_ev);
	evtimer_add(&amp;timer_ev, &amp;tv);
	event_dispatch();
}

void
usage(void)
{
	if (v6flag) {
		fprintf(stderr, &quot;usage: %s &quot;
		    &quot;[-ADdIlnSv] [-f first_hop] [-m max_hop] [-p port]\n&quot;
		    &quot;\t[-q nqueries] [-s sourceaddr] [-t toskeyword] [-V rtable] &quot;
		    &quot;[-w waittime]\n\thost [datalen]\n&quot;, __progname);
	} else {
		fprintf(stderr,
		    &quot;usage: %s [-ADdIlnSvx] [-f first_ttl] [-g gateway_addr] &quot;
		    &quot;[-m max_ttl]\n&quot;
		    &quot;\t[-P proto] [-p port] [-q nqueries] [-s sourceaddr]\n&quot;
		    &quot;\t[-t toskeyword] &quot;
		    &quot;[-V rtable] [-w waittime] host [datalen]\n&quot;,
		    __progname);
	}
	exit(1);
}

void
sock_read(int fd, short events, void *arg)
{
	struct ip	*ip;
	struct timeval	 t2, tv = {0, 0};
	int		 pkg_ok, cc, recv_seq, recv_seq_row;
	char		 hbuf[NI_MAXHOST];

	cc = recvmsg(rcvsock, &amp;rcvmhdr, 0);

	if (cc == 0)
		return;

	evtimer_add(&amp;timer_ev, &amp;tv);

	gettime(&amp;t2);

	pkg_ok = packet_ok(conf, to-&gt;sa_family, &amp;rcvmhdr, cc, &amp;recv_seq);

	/* Skip wrong packet */
	if (pkg_ok == 0)
		goto out;

	/* skip corrupt sequence number */
	if (recv_seq &lt; 0 || recv_seq &gt;= conf-&gt;max_ttl * conf-&gt;nprobes)
		goto out;

	recv_seq_row = recv_seq / conf-&gt;nprobes;

	/* skipping dup */
	if (tr_results[recv_seq].dup++)
		goto out;

	switch (to-&gt;sa_family) {
	case AF_INET:
		ip = (struct ip *)packet;

		print(conf, from, cc - (ip-&gt;ip_hl &lt;&lt; 2), inet_ntop(AF_INET,
		    &amp;ip-&gt;ip_dst, hbuf, sizeof(hbuf)), &amp;tr_results[recv_seq]);
		break;
	case AF_INET6:
		print(conf, from, cc, rcvpktinfo ? inet_ntop(AF_INET6,
		    &amp;rcvpktinfo-&gt;ipi6_addr, hbuf, sizeof(hbuf)) : &quot;?&quot;,
		    &amp;tr_results[recv_seq]);
		break;
	default:
		errx(1, &quot;unsupported AF: %d&quot;, to-&gt;sa_family);
	}

	tr_results[recv_seq].t2 = t2;
	tr_results[recv_seq].resp_ttl = v6flag ? rcvhlim : ip-&gt;ip_ttl;

	waiting_ttls[recv_seq_row]--;

	if (pkg_ok == -2) {
		if ((v6flag &amp;&amp; rcvhlim &lt;= 1) ||
		    (!v6flag &amp;&amp; ip-&gt;ip_ttl &lt;=1))
			snprintf(tr_results[recv_seq].icmp_code,
			    sizeof(tr_results[recv_seq].icmp_code), &quot;%s&quot;, &quot; !&quot;);
		tr_results[recv_seq].got_there++;
	} else {
		if (to-&gt;sa_family == AF_INET &amp;&amp; conf-&gt;tflag)
			check_tos(ip, &amp;last_tos, &amp;tr_results[recv_seq]);
		if (pkg_ok != -1) {
			icmp_code(to-&gt;sa_family, pkg_ok - 1,
			    &amp;tr_results[recv_seq].got_there,
			    &amp;tr_results[recv_seq].unreachable,
			    &amp;tr_results[recv_seq]);
		}
	}

	if (cc &amp;&amp; ((recv_seq + 1) % conf-&gt;nprobes) == 0 &amp;&amp;
	    (conf-&gt;xflag || conf-&gt;verbose))
		print_exthdr(packet, cc, &amp;tr_results[recv_seq]);
 out:
	catchup_result_rows(tr_results, conf);
}

void
send_timer(int fd, short events, void *arg)
{
	static int	 seq;
	struct timeval	 tv = {0, 30000}, t1;
	struct event	*ev = arg;
	int		 ttl;

	evtimer_add(ev, &amp;tv);

	ttl = conf-&gt;first_ttl + seq / conf-&gt;nprobes;
	if (ttl &lt;= conf-&gt;max_ttl) {
		gettime(&amp;t1);
		tr_results[seq].seq = seq;
		tr_results[seq].row = seq / conf-&gt;nprobes;
		tr_results[seq].ttl = ttl;
		tr_results[seq].t1 = t1;
		send_probe(conf, seq, ttl, to);
		seq++;
	}

	catchup_result_rows(tr_results, conf);

}

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="52-icmp"><a class="header" href="#52-icmp">5.2 ICMP</a></h1>
<p>ICMP (Internet Control Message Protocol) is a network protocol used for sending control messages and error reports between network devices. It operates at the network layer (Layer 3) of the OSI model and is an integral part of the IP protocol suite.</p>
<h3 id="key-functions-of-icmp"><a class="header" href="#key-functions-of-icmp">Key Functions of ICMP</a></h3>
<ol>
<li>
<p><strong>Error Reporting</strong>:</p>
<ul>
<li>ICMP is used to report errors and provide feedback about issues encountered during communication. For example, if a packet cannot reach its destination because the network is down or the destination is unreachable, ICMP will send a message back to the source to indicate the problem.</li>
</ul>
</li>
<li>
<p><strong>Network Diagnostics</strong>:</p>
<ul>
<li>ICMP is commonly used for network diagnostics and troubleshooting tools, such as <code>ping</code> and <code>traceroute</code>. These tools help determine whether a network host is reachable and trace the path taken by packets across a network.</li>
</ul>
</li>
</ol>
<h3 id="common-icmp-messages"><a class="header" href="#common-icmp-messages">Common ICMP Messages</a></h3>
<ol>
<li>
<p><strong>Echo Request and Echo Reply</strong>:</p>
<ul>
<li><strong>Echo Request</strong>: Sent by the <code>ping</code> command to check if a host is reachable.</li>
<li><strong>Echo Reply</strong>: Sent in response to an Echo Request, indicating that the host is reachable.</li>
</ul>
</li>
<li>
<p><strong>Destination Unreachable</strong>:</p>
<ul>
<li>Sent when a packet cannot be delivered to its destination. This message may indicate various types of issues, such as the destination network being unreachable, the destination host being unreachable, or the protocol or port being unreachable.</li>
</ul>
</li>
<li>
<p><strong>Time Exceeded</strong>:</p>
<ul>
<li>Sent when a packet's Time to Live (TTL) value expires. This is often used in tools like <code>traceroute</code> to determine the path taken by packets and measure the round-trip time to each hop.</li>
</ul>
</li>
<li>
<p><strong>Redirect</strong>:</p>
<ul>
<li>Sent by a router to inform the sender that a better route is available for a particular destination.</li>
</ul>
</li>
</ol>
<h3 id="example-use-cases"><a class="header" href="#example-use-cases">Example Use Cases</a></h3>
<ul>
<li><strong>Ping</strong>: Uses ICMP Echo Request and Echo Reply messages to check the availability of a host and measure round-trip time.</li>
<li><strong>Traceroute</strong>: Uses ICMP Time Exceeded messages to determine the route taken by packets from source to destination and identify intermediate routers.</li>
</ul>
<h3 id="how-icmp-works"><a class="header" href="#how-icmp-works">How ICMP Works</a></h3>
<p>When a network device, such as a router, receives a packet, it processes the packet and may generate an ICMP message if there are issues or specific conditions. For instance, if a router cannot forward a packet because its TTL has expired, it will send an ICMP Time Exceeded message back to the source of the packet.</p>
<p>In summary, ICMP plays a crucial role in network management and troubleshooting by providing mechanisms to report errors and gather diagnostic information about network operations.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="53-using-curl-for-measuring-performance"><a class="header" href="#53-using-curl-for-measuring-performance">5.3 Using Curl for measuring performance</a></h1>
<ul>
<li>App is here: <a href="https://mohanperf.streamlit.app/">Curl Performance Metrics App</a></li>
</ul>
<p><img src="networking/../img/curl-perf-1.png" alt="Curl Performance Metrics App" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="6-uiux"><a class="header" href="#6-uiux">6. UI/UX</a></h1>
<h2 id="notes-about-multiple-levels-tabs-in-a-single-page-in-spa"><a class="header" href="#notes-about-multiple-levels-tabs-in-a-single-page-in-spa">Notes about multiple levels tabs in a single page in SPA</a></h2>
<p>Implementing multiple levels of tabs in a single page within a Single Page Application (SPA) can lead to various issues. Here are some common challenges and issues you might encounter:</p>
<h3 id="1-complexity-in-design-and-navigation"><a class="header" href="#1-complexity-in-design-and-navigation">1. <strong>Complexity in Design and Navigation</strong></a></h3>
<ul>
<li><strong>User Confusion</strong>: Multiple levels of tabs can lead to confusion if the hierarchy is not intuitive. Users might struggle to understand where they are within the application and how to navigate back to previous levels.</li>
<li><strong>Overwhelming UI</strong>: A complex tab structure can overwhelm users, especially if there are too many levels or the tabs are not clearly differentiated.</li>
</ul>
<h3 id="2-performance-concerns"><a class="header" href="#2-performance-concerns">2. <strong>Performance Concerns</strong></a></h3>
<ul>
<li><strong>Increased DOM Size</strong>: Deeply nested tabs can result in a large DOM structure, which might impact the performance of the page. This can lead to slower rendering times and reduced responsiveness.</li>
<li><strong>JavaScript Performance</strong>: Managing multiple levels of tabs can lead to increased complexity in JavaScript code, which might affect performance and lead to potential bugs.</li>
</ul>
<h3 id="3-state-management"><a class="header" href="#3-state-management">3. <strong>State Management</strong></a></h3>
<ul>
<li><strong>Complex State Handling</strong>: Keeping track of the state across multiple levels of tabs can be challenging. You need to manage which tab is active at each level and ensure that the state is preserved correctly.</li>
<li><strong>State Synchronization</strong>: Synchronizing state between different levels of tabs and ensuring consistency can be complex, particularly in applications with dynamic content.</li>
</ul>
<h3 id="4-accessibility-issues"><a class="header" href="#4-accessibility-issues">4. <strong>Accessibility Issues</strong></a></h3>
<ul>
<li><strong>Keyboard Navigation</strong>: Ensuring that keyboard navigation is smooth and intuitive across multiple levels of tabs can be difficult. Users relying on keyboard navigation might face challenges if the tab navigation is not well implemented.</li>
<li><strong>Screen Reader Compatibility</strong>: Making sure that screen readers can correctly interpret and navigate through multiple levels of tabs is crucial for accessibility. Improper implementation might lead to a poor experience for users with disabilities.</li>
</ul>
<h3 id="5-responsiveness-and-mobile-experience"><a class="header" href="#5-responsiveness-and-mobile-experience">5. <strong>Responsiveness and Mobile Experience</strong></a></h3>
<ul>
<li><strong>Mobile Adaptation</strong>: Complex tab structures might not translate well to smaller screens. Managing multiple levels of tabs on mobile devices can lead to usability issues and require additional design considerations.</li>
<li><strong>Touch Interaction</strong>: Ensuring that touch interactions are smooth and responsive across different levels of tabs can be challenging, particularly if the tabs are nested deeply.</li>
</ul>
<h3 id="6-user-experience"><a class="header" href="#6-user-experience">6. <strong>User Experience</strong></a></h3>
<ul>
<li><strong>Over-Nesting</strong>: Over-nesting tabs can lead to a deep navigation hierarchy that might be difficult for users to navigate. Users might find it hard to remember their place or navigate back to a previous level.</li>
<li><strong>Content Visibility</strong>: Ensuring that content is visible and accessible at each level of tabs without excessive scrolling or searching can be challenging.</li>
</ul>
<h3 id="7-debugging-and-maintenance"><a class="header" href="#7-debugging-and-maintenance">7. <strong>Debugging and Maintenance</strong></a></h3>
<ul>
<li><strong>Complex Codebase</strong>: Managing a complex tab structure can result in a more complicated codebase, making it harder to debug and maintain. Code related to tab interactions and state management might become harder to follow and manage.</li>
<li><strong>Testing</strong>: Testing interactions and ensuring that all edge cases are handled correctly becomes more complex with multiple levels of tabs.</li>
</ul>
<h3 id="best-practices-to-mitigate-issues"><a class="header" href="#best-practices-to-mitigate-issues">Best Practices to Mitigate Issues:</a></h3>
<ol>
<li><strong>Design for Clarity</strong>: Keep the tab hierarchy intuitive and easy to understand. Avoid deep nesting if possible and ensure that the tab structure aligns with the user's mental model.</li>
<li><strong>Performance Optimization</strong>: Optimize performance by minimizing DOM complexity and using efficient JavaScript code. Lazy load content if necessary to improve page responsiveness.</li>
<li><strong>State Management</strong>: Use state management libraries or frameworks that handle complex state interactions efficiently. Ensure that state transitions are smooth and predictable.</li>
<li><strong>Accessibility</strong>: Follow best practices for accessibility, including proper keyboard navigation and screen reader support. Ensure that the tab structure is easily navigable for all users.</li>
<li><strong>Responsive Design</strong>: Test the tab interface on various screen sizes and devices to ensure a good user experience across all platforms. Consider alternative designs for mobile devices if needed.</li>
<li><strong>User Testing</strong>: Conduct user testing to identify potential usability issues and gather feedback on the tab interface. Iterate based on user feedback to improve the design.</li>
</ol>
<p>By addressing these issues and following best practices, you can create a more effective and user-friendly tab interface within your SPA.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="61-best-practices"><a class="header" href="#61-best-practices">6.1 Best Practices</a></h1>
<p>Good UI/UX design is crucial for creating intuitive, user-friendly, and engaging experiences. Here are some best practices to follow:</p>
<h3 id="1-understand-your-users"><a class="header" href="#1-understand-your-users">1. <strong>Understand Your Users</strong></a></h3>
<ul>
<li><strong>User Research</strong>: Conduct surveys, interviews, and usability testing to understand user needs, preferences, and behaviors.</li>
<li><strong>User Personas</strong>: Create personas to represent different segments of your target audience.</li>
</ul>
<h3 id="2-keep-it-simple"><a class="header" href="#2-keep-it-simple">2. <strong>Keep It Simple</strong></a></h3>
<ul>
<li><strong>Minimalism</strong>: Avoid clutter. Focus on essential elements and remove anything unnecessary.</li>
<li><strong>Consistency</strong>: Use consistent design patterns and language throughout the application.</li>
</ul>
<h3 id="3-design-for-usability"><a class="header" href="#3-design-for-usability">3. <strong>Design for Usability</strong></a></h3>
<ul>
<li><strong>Intuitive Navigation</strong>: Ensure that users can easily find what they need with clear, logical navigation.</li>
<li><strong>Accessibility</strong>: Design for accessibility, including considerations for color blindness, screen readers, and keyboard navigation.</li>
</ul>
<h3 id="4-visual-hierarchy"><a class="header" href="#4-visual-hierarchy">4. <strong>Visual Hierarchy</strong></a></h3>
<ul>
<li><strong>Contrast and Color</strong>: Use contrast to highlight important elements and guide users’ attention.</li>
<li><strong>Typography</strong>: Choose legible fonts and use size, weight, and spacing to create a clear hierarchy.</li>
</ul>
<h3 id="5-responsive-design"><a class="header" href="#5-responsive-design">5. <strong>Responsive Design</strong></a></h3>
<ul>
<li><strong>Mobile-First</strong>: Design for smaller screens first and scale up for larger devices.</li>
<li><strong>Fluid Layouts</strong>: Use flexible grids and media queries to ensure your design works on various devices.</li>
</ul>
<h3 id="6-feedback-and-interaction"><a class="header" href="#6-feedback-and-interaction">6. <strong>Feedback and Interaction</strong></a></h3>
<ul>
<li><strong>Visual Feedback</strong>: Provide feedback for user actions, such as button clicks or form submissions, to confirm actions.</li>
<li><strong>Error Handling</strong>: Display clear error messages and guide users on how to correct issues.</li>
</ul>
<h3 id="7-performance-optimization"><a class="header" href="#7-performance-optimization">7. <strong>Performance Optimization</strong></a></h3>
<ul>
<li><strong>Load Time</strong>: Optimize images, scripts, and other assets to reduce load times.</li>
<li><strong>Smooth Interactions</strong>: Ensure animations and transitions are smooth and don’t hinder performance.</li>
</ul>
<h3 id="8-user-control"><a class="header" href="#8-user-control">8. <strong>User Control</strong></a></h3>
<ul>
<li><strong>Undo/Redo</strong>: Allow users to easily undo or redo actions.</li>
<li><strong>Clear Actions</strong>: Provide users with clear options to proceed or cancel actions.</li>
</ul>
<h3 id="9-test-and-iterate"><a class="header" href="#9-test-and-iterate">9. <strong>Test and Iterate</strong></a></h3>
<ul>
<li><strong>Usability Testing</strong>: Regularly test with real users to identify issues and gather feedback.</li>
<li><strong>A/B Testing</strong>: Use A/B testing to compare different design versions and determine which performs better.</li>
</ul>
<h3 id="10-aesthetic-integrity"><a class="header" href="#10-aesthetic-integrity">10. <strong>Aesthetic Integrity</strong></a></h3>
<ul>
<li><strong>Visual Appeal</strong>: Ensure your design is visually appealing and aligns with your brand identity.</li>
<li><strong>Balance</strong>: Use visual balance to create a harmonious and engaging design.</li>
</ul>
<h3 id="11-data-driven-decisions"><a class="header" href="#11-data-driven-decisions">11. <strong>Data-Driven Decisions</strong></a></h3>
<ul>
<li><strong>Analytics</strong>: Use analytics to track user behavior and make data-driven design decisions.</li>
<li><strong>User Feedback</strong>: Incorporate user feedback into design improvements.</li>
</ul>
<h3 id="12-security-and-privacy"><a class="header" href="#12-security-and-privacy">12. <strong>Security and Privacy</strong></a></h3>
<ul>
<li><strong>Data Protection</strong>: Ensure that user data is protected and that users are aware of privacy practices.</li>
<li><strong>Secure Authentication</strong>: Implement secure authentication methods to protect user accounts.</li>
</ul>
<h3 id="13-provide-help-and-documentation"><a class="header" href="#13-provide-help-and-documentation">13. <strong>Provide Help and Documentation</strong></a></h3>
<ul>
<li><strong>Onboarding</strong>: Offer onboarding experiences for new users to familiarize them with your application.</li>
<li><strong>Help Resources</strong>: Provide easily accessible help resources, such as FAQs and support options.</li>
</ul>
<h3 id="14-consistency-across-platforms"><a class="header" href="#14-consistency-across-platforms">14. <strong>Consistency Across Platforms</strong></a></h3>
<ul>
<li><strong>Unified Experience</strong>: Ensure that your design provides a consistent experience across different platforms and devices.</li>
</ul>
<h3 id="15-continuous-improvement"><a class="header" href="#15-continuous-improvement">15. <strong>Continuous Improvement</strong></a></h3>
<ul>
<li><strong>Stay Updated</strong>: Keep up with design trends and technological advancements.</li>
<li><strong>Adapt and Evolve</strong>: Continuously update and improve your design based on user needs and feedback.</li>
</ul>
<p>By following these best practices, you can create designs that are not only visually appealing but also functional, user-friendly, and effective in meeting user needs.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="62-accessibility"><a class="header" href="#62-accessibility">6.2 Accessibility</a></h1>
<p>Best practices for accessibility in UI/UX design ensure that digital products are usable and inclusive for all users, including those with disabilities. Following accessibility guidelines improves usability, reach, and compliance with legal standards (such as the Web Content Accessibility Guidelines (WCAG)).</p>
<p>Here are the best practices for accessibility in UI/UX design:</p>
<h3 id="1-use-semantic-html"><a class="header" href="#1-use-semantic-html">1. <strong>Use Semantic HTML</strong></a></h3>
<ul>
<li><strong>Why</strong>: Semantic HTML provides meaning to web content, making it easier for screen readers and assistive technologies to interpret the content.</li>
<li><strong>How</strong>: Use appropriate HTML elements (e.g., <code>&lt;nav&gt;</code>, <code>&lt;header&gt;</code>, <code>&lt;main&gt;</code>, <code>&lt;article&gt;</code>, <code>&lt;button&gt;</code>) to structure your content clearly.
<ul>
<li>Example: Use <code>&lt;button&gt;</code> for clickable buttons rather than <code>&lt;div&gt;</code> or <code>&lt;span&gt;</code>.</li>
</ul>
</li>
</ul>
<h3 id="2-ensure-keyboard-navigation"><a class="header" href="#2-ensure-keyboard-navigation">2. <strong>Ensure Keyboard Navigation</strong></a></h3>
<ul>
<li><strong>Why</strong>: Many users with motor impairments rely on keyboard navigation rather than a mouse or touchscreen.</li>
<li><strong>How</strong>: Ensure that all interactive elements, such as links, buttons, and form fields, are accessible via the keyboard using <code>Tab</code>, <code>Enter</code>, and <code>Arrow</code> keys.
<ul>
<li>Example: Focus states should be visible and distinct to help users understand where they are navigating on the page.</li>
</ul>
</li>
</ul>
<h3 id="3-provide-text-alternatives-alt-text"><a class="header" href="#3-provide-text-alternatives-alt-text">3. <strong>Provide Text Alternatives (Alt Text)</strong></a></h3>
<ul>
<li><strong>Why</strong>: Users with visual impairments rely on screen readers, which read aloud alternative text for images and non-text content.</li>
<li><strong>How</strong>: Add descriptive <code>alt</code> attributes for images that convey important information. For decorative images, use <code>alt=&quot;&quot;</code>.
<ul>
<li>Example: For a &quot;Buy Now&quot; button image, use <code>alt=&quot;Buy Now button&quot;</code>.</li>
</ul>
</li>
</ul>
<h3 id="4-maintain-color-contrast"><a class="header" href="#4-maintain-color-contrast">4. <strong>Maintain Color Contrast</strong></a></h3>
<ul>
<li><strong>Why</strong>: Users with visual impairments, color blindness, or low vision may struggle with low contrast between text and background colors.</li>
<li><strong>How</strong>: Ensure text has sufficient color contrast with its background. WCAG recommends a minimum contrast ratio of 4.5:1 for normal text and 3:1 for large text.
<ul>
<li>Example: Use a contrast checker tool to verify the readability of your color combinations.</li>
</ul>
</li>
</ul>
<h3 id="5-avoid-using-color-alone-to-convey-information"><a class="header" href="#5-avoid-using-color-alone-to-convey-information">5. <strong>Avoid Using Color Alone to Convey Information</strong></a></h3>
<ul>
<li><strong>Why</strong>: Users with color blindness or visual impairments may not perceive colors as expected.</li>
<li><strong>How</strong>: Use other visual indicators like icons, text labels, or patterns in addition to color to convey meaning.
<ul>
<li>Example: When using red to indicate an error, include an icon or text (e.g., &quot;Error: Please enter a valid email&quot;).</li>
</ul>
</li>
</ul>
<h3 id="6-use-descriptive-link-text"><a class="header" href="#6-use-descriptive-link-text">6. <strong>Use Descriptive Link Text</strong></a></h3>
<ul>
<li><strong>Why</strong>: Screen readers read out link text, so descriptive link text improves context for visually impaired users.</li>
<li><strong>How</strong>: Use meaningful link text that describes the link’s destination, rather than vague text like “Click here” or “Read more.”
<ul>
<li>Example: Instead of &quot;Click here,&quot; use &quot;Learn more about accessibility best practices.&quot;</li>
</ul>
</li>
</ul>
<h3 id="7-label-form-elements-properly"><a class="header" href="#7-label-form-elements-properly">7. <strong>Label Form Elements Properly</strong></a></h3>
<ul>
<li><strong>Why</strong>: Users with assistive technologies need clear labels for form fields to understand their purpose.</li>
<li><strong>How</strong>: Use the <code>&lt;label&gt;</code> element to associate form labels with input fields. Ensure placeholders do not replace proper labels, as placeholders disappear when users type.
<ul>
<li>Example: <code>&lt;label for=&quot;email&quot;&gt;Email Address:&lt;/label&gt; &lt;input id=&quot;email&quot; type=&quot;email&quot;&gt;</code></li>
</ul>
</li>
</ul>
<h3 id="8-design-accessible-focus-states"><a class="header" href="#8-design-accessible-focus-states">8. <strong>Design Accessible Focus States</strong></a></h3>
<ul>
<li><strong>Why</strong>: Focus states help keyboard users identify which element is currently selected or actionable.</li>
<li><strong>How</strong>: Ensure that focusable elements (e.g., buttons, links, inputs) have clear, visible focus styles that help users see where their focus is on the screen.
<ul>
<li>Example: Use an outline or border change when an element is in focus: <code>:focus { outline: 2px solid blue; }</code>.</li>
</ul>
</li>
</ul>
<h3 id="9-provide-captions-and-transcripts-for-multimedia"><a class="header" href="#9-provide-captions-and-transcripts-for-multimedia">9. <strong>Provide Captions and Transcripts for Multimedia</strong></a></h3>
<ul>
<li><strong>Why</strong>: Deaf and hard-of-hearing users rely on captions or transcripts to understand audio or video content.</li>
<li><strong>How</strong>: Add captions to videos and provide transcripts for audio content. Ensure that live audio streams have real-time captions when possible.
<ul>
<li>Example: For a video tutorial, include captions that describe both spoken content and relevant sounds.</li>
</ul>
</li>
</ul>
<h3 id="10-test-for-screen-reader-compatibility"><a class="header" href="#10-test-for-screen-reader-compatibility">10. <strong>Test for Screen Reader Compatibility</strong></a></h3>
<ul>
<li><strong>Why</strong>: Screen readers are vital for visually impaired users, and your website or app needs to be usable with these tools.</li>
<li><strong>How</strong>: Regularly test your website with screen readers (e.g., NVDA, JAWS, or VoiceOver) to ensure proper navigation, labeling, and content flow.
<ul>
<li>Example: Check if headings, buttons, and interactive elements are announced correctly by the screen reader.</li>
</ul>
</li>
</ul>
<h3 id="11-enable-resizable-text"><a class="header" href="#11-enable-resizable-text">11. <strong>Enable Resizable Text</strong></a></h3>
<ul>
<li><strong>Why</strong>: Some users may need to increase text size to read comfortably.</li>
<li><strong>How</strong>: Ensure that your design allows users to resize text without breaking the layout. Avoid setting text size in pixels (px) and use relative units like <code>em</code> or <code>rem</code>.
<ul>
<li>Example: Instead of <code>font-size: 14px;</code>, use <code>font-size: 1rem;</code> to allow scalability.</li>
</ul>
</li>
</ul>
<h3 id="12-implement-aria-accessible-rich-internet-applications-properly"><a class="header" href="#12-implement-aria-accessible-rich-internet-applications-properly">12. <strong>Implement ARIA (Accessible Rich Internet Applications) Properly</strong></a></h3>
<ul>
<li><strong>Why</strong>: ARIA attributes help make dynamic or complex UI components accessible to assistive technologies.</li>
<li><strong>How</strong>: Use ARIA attributes (like <code>aria-label</code>, <code>role</code>, <code>aria-expanded</code>, etc.) to provide additional information about interactive elements. However, avoid using ARIA when native HTML elements serve the same purpose.
<ul>
<li>Example: Use <code>role=&quot;alert&quot;</code> to inform assistive technologies of dynamic alerts without focusing the user on the element.</li>
</ul>
</li>
</ul>
<h3 id="13-ensure-time-sensitive-content-is-accessible"><a class="header" href="#13-ensure-time-sensitive-content-is-accessible">13. <strong>Ensure Time-Sensitive Content is Accessible</strong></a></h3>
<ul>
<li><strong>Why</strong>: Some users need more time to interact with content, and fast changes or time-outs can make it difficult for them.</li>
<li><strong>How</strong>: Avoid automatic content updates or time-outs without giving users a way to extend the time or control the updates.
<ul>
<li>Example: Provide a &quot;stay logged in&quot; option for time-sensitive forms to prevent session time-outs.</li>
</ul>
</li>
</ul>
<h3 id="14-provide-responsive-and-mobile-friendly-designs"><a class="header" href="#14-provide-responsive-and-mobile-friendly-designs">14. <strong>Provide Responsive and Mobile-Friendly Designs</strong></a></h3>
<ul>
<li><strong>Why</strong>: Many users rely on mobile devices or smaller screens, which can affect accessibility, especially for those with motor impairments.</li>
<li><strong>How</strong>: Design responsive layouts that adapt to various screen sizes, and ensure touch targets (buttons, links) are large enough to be tapped easily.
<ul>
<li>Example: Make buttons at least 44x44 pixels for mobile devices to accommodate users with dexterity challenges.</li>
</ul>
</li>
</ul>
<h3 id="15-ensure-consistent-navigation-and-structure"><a class="header" href="#15-ensure-consistent-navigation-and-structure">15. <strong>Ensure Consistent Navigation and Structure</strong></a></h3>
<ul>
<li><strong>Why</strong>: Consistency helps all users, including those with cognitive disabilities, navigate and understand your site better.</li>
<li><strong>How</strong>: Maintain a clear, consistent navigation structure across your pages, and use predictable patterns to reduce cognitive load.
<ul>
<li>Example: Place navigation menus in the same location on every page.</li>
</ul>
</li>
</ul>
<h3 id="16-test-with-real-users"><a class="header" href="#16-test-with-real-users">16. <strong>Test with Real Users</strong></a></h3>
<ul>
<li><strong>Why</strong>: Real user testing helps identify accessibility issues that may not be caught by automated tools.</li>
<li><strong>How</strong>: Include users with disabilities in usability testing sessions to gain insight into how accessible your product is in real-world scenarios.</li>
</ul>
<h3 id="conclusion-2"><a class="header" href="#conclusion-2">Conclusion</a></h3>
<p>By following these best practices, you can ensure that your UI/UX designs are accessible to a wide range of users, including those with disabilities. It enhances user satisfaction, improves reach, and aligns with legal accessibility standards.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
